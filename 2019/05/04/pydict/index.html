

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/howl.jpg">
  <link rel="icon" type="image/png" href="/img/howl.jpg">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="Is Life Always This Hard? / After all this time?">
  <meta name="author" content="aptend">
  <meta name="keywords" content="">
  <title>Python字典内部实现 - No one</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"aptend.com","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":"69fdc2c3cb74b3ea985d8b632943139a","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>No one</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg/post.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Python字典内部实现">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2019-05-04 17:12" pubdate>
        May 4, 2019 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      7.1k 字
    </span>
  

  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Python字典内部实现</h1>
            
            <div class="markdown-body">
              <blockquote>
<p>这一篇会比较长。和这个系列的文章一样，主要目标读者是自己，以及一些希望了解字典内部工作原理，并且已经在半路上的人。我会用Python代码翻译CPython的实现。考察对象包括3.6之前的普通字典，3.6之后的compact字典。重点放在字典的核心逻辑，会省略比如字典迭代、字典合并、缓冲池、查找时的变动检查等特性和细节。</p>
</blockquote>
<a id="more"></a>
<h1 id="新老字典大乱斗"><a href="#新老字典大乱斗" class="headerlink" title="新老字典大乱斗"></a>新老字典大乱斗</h1><h2 id="0-准备"><a href="#0-准备" class="headerlink" title="0. 准备"></a>0. 准备</h2><h3 id="字典应用场景"><a href="#字典应用场景" class="headerlink" title="字典应用场景"></a>字典应用场景</h3><p>参考源码中的这段<a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/3.7/Objects/dictnotes.txt#L4">说明</a>，先捋一下字典的应用场景，对字典有个更全面的认识。对后面了解字典内存优化也有帮助</p>
<p>Python内部实现层面：</p>
<div class="hljs code-wrapper"><pre><code>1. 传递关键字参数。大小1-3，写少，读少
2. 查找类方法。大小8-10，写少，读多
3. 实例attribute，全局变量查找。大小不定，大概率4-10，频繁读写
4. builtins。大小150左右，不写，频繁读。
</code></pre></div><p>应用层面：</p>
<ol>
<li>动态映射。添加、删除、替换交替进行。比如服务发现中的注册、过期、更新</li>
<li>成员测试。创建时写入key一次，之后基本不变，频繁调用__contains__()</li>
<li>uniquification。主要工作发生在字典的创建过程中，对小范围的key反复读写，比如去重、Counter、反向索引</li>
</ol>
<h3 id="Hash-Table"><a href="#Hash-Table" class="headerlink" title="Hash Table"></a>Hash Table</h3><p>关于hash表的考量，同样来自源码的<a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/3.7/Objects/dictobject.c#L134">注释</a>，以下为个人意译</p>
<p>Python选择开放地址法而不是拉链法，因为拉链法要维护额外的连接，开销更大</p>
<blockquote>
<p>来自未来的说明 2020-12:<br>开放地址法能更好地利用CPU的缓存</p>
</blockquote>
<p>大多数hash方案都依赖于一个“好”的hash函数，能出色地模拟随机性，均匀地散布key。但Python并没有沿着这条路走，它最重要的hash函数，针对int类型的，显得非常平常，可预期：</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">&gt;&gt;&gt;[<span class="hljs-built_in">hash</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>)]<br>[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<br></code></pre></div></td></tr></table></figure>
<p>实际上这并没有想象中那么坏。在特定环境下，比如，在一个大小为$2^i$的符号表中，key是连续整型，那么直接使用key的hash值(就是key)最后i个bit作为索引，真滴非常快，还没有冲突，比随机算一个可能引发冲突的索引更有效</p>
<p>但是另一方面，如果冲突确实发生了，想快速插入已经连被续填充的hash表，必须得有一个更精细的冲突解决策略。同时，使用低i位为索引这行为本身，也存在脆弱的极端情况，比如，考虑<code>[i &lt;&lt; 16 for i in range(20000)]</code>作为key，去填充$2^{15}$的hash表，那么取后15位就会出现index<strong>全为0</strong>的情况</p>
<p>但是对这种特殊情况的处理不能损害常规情况下的处理速度，所以我们还是用低i位bit作为key在表中的index，剩下的仰仗于冲突解决策略。如果通常第一次查找就能找到我们所期待的key(事实证明，这也确实是常规情况，因为会把装载率控制在2/3以下)，那么像这样，把第一次index计算整得快一点，收效会很大。</p>
<p>冲突解决方案的第一部分:</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># 第一次映射到index，直接使用较低的i位</span><br><span class="hljs-comment"># 因为是二次幂，等效于取余，这里为简便就这么写吧</span><br>j = hashvalue % <span class="hljs-number">2</span>**i <span class="hljs-comment"># j = hashvalue &amp; (2**i - 1)</span><br><span class="hljs-keyword">while</span> not_found(j):<br>    j = ((<span class="hljs-number">5</span>*j)+<span class="hljs-number">1</span>) % <span class="hljs-number">2</span>**i <span class="hljs-comment"># 然后就可以按照特定顺序遍历index</span><br></code></pre></div></td></tr></table></figure>
<p>对于$j\in[0,2^i)$，上式重复$2^i$次，会把$[0,2^i)$中每个数确切地再现一次。等于说，这是一个变相的遍历函数。比如对于容量为8的表，以0开头</p>
<p>0 -&gt; 1 -&gt; 6 -&gt; 7 -&gt; 4 -&gt; 5 -&gt; 2 -&gt; 3 -&gt; 0 -&gt; 1 -&gt; 6 [重复]</p>
<p>这种方式遍历和线性遍历相比有什么好处呢？大概就是在现实生活中，这种顺序的数字序列远比连续数字序列出现的概率小。如果两个hash值在index5冲突，后一个会去找index2，而不是index6，这样接下更可能出现的hash为index6的key就不会冲突。</p>
<p>冲突解决方案的第二部分，就要在后续的每一步位置探测中都把hashvalue考虑进来。如果不考虑hashvalue，那么后i位相同的hashvalue所产生的探测序列都是一样的，这并不是一个高效的冲突解决方案。</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">j = hashvalue % <span class="hljs-number">2</span>**i <span class="hljs-comment"># 第一次映射到index，直接使用较低的i位</span><br>perturb = hashvalue<br><span class="hljs-keyword">while</span> not_found(j):<br>    perturb &gt;&gt;= PERTURB_SHIFT<br>    j = ((<span class="hljs-number">5</span>*j) + <span class="hljs-number">1</span> + perturb) % <span class="hljs-number">2</span>**i <span class="hljs-comment"># 然后使用perturb提供的信息进行探测下一个位置</span><br></code></pre></div></td></tr></table></figure>
<p>探测依赖hashvalue所有bit位，因为通过+perturb，快速放大了那些不会影响初始位置的bit位之间的微小差异(毕竟只有后i位可以决定初始index嘛)。注意perturb是无符号数，所以最终会变为0，回归到第一部分的原始遍历函数，一定能找到一个空位。</p>
<p>如何选择PERTUR_SHIFT的值？这需要一定的权衡。小一点，那么hashvalue的高位bit将<strong>更多</strong>地参与到探测序列生成中来；大一点，也能使高位bit<strong>更快速</strong>地影响序列生成，这对之前讨论的极端情况是有利的。最后实验得出5能够最小化冲突，当然4、6也差不到哪里去</p>
<p>生成探测序列，<a target="_blank" rel="noopener" href="http://code.activestate.com/recipes/578375/">参考链接</a></p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_probes</span>(<span class="hljs-params">hashvalue, mask</span>):</span><br>    <span class="hljs-string">&#x27;Same sequence of probes used in the current dictionary design&#x27;</span><br>    PERTURB_SHIFT = <span class="hljs-number">5</span><br>    <span class="hljs-keyword">if</span> hashvalue &lt; <span class="hljs-number">0</span>:<br>        hashvalue = -hashvalue<br>    i = hashvalue &amp; mask <span class="hljs-comment">#取得第一次的index</span><br>    <span class="hljs-keyword">yield</span> i<br>    perturb = hashvalue<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>: <span class="hljs-comment">#循环开始</span><br>        i = (<span class="hljs-number">5</span> * i + perturb + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xFFFFFFFFFFFFFFFF</span><br>        <span class="hljs-keyword">yield</span> i &amp; mask<br>        perturb &gt;&gt;= PERTURB_SHIFT<br></code></pre></div></td></tr></table></figure>
<h2 id="1-Legacy-Dictionary"><a href="#1-Legacy-Dictionary" class="headerlink" title="1. Legacy Dictionary"></a>1. Legacy Dictionary</h2><p>这里先介绍3.6之前的字典，关键参考的是《Python源码剖析》。</p>
<h3 id="数据结构-amp-初始化"><a href="#数据结构-amp-初始化" class="headerlink" title="数据结构 &amp; 初始化"></a>数据结构 &amp; 初始化</h3><p>数据结构分为，1.储存键值的Entry；2.维护Entries的容器Dict</p>
<p>PyDictEntry</p>
<ul>
<li>me_hash</li>
<li>me_key</li>
<li>me_value</li>
</ul>
<p>PyDictObject</p>
<ul>
<li><p>ma_fill: 被使用过的entry数， Active+Dummy</p>
</li>
<li><p>ma_used: 正在被使用的entry数，Active</p>
</li>
<li><p>ma_mask: $2^n-1$，变相表达字典容量，减1为了方便与运算获得角标位置</p>
</li>
<li><p>ma_table：entries，储存key-value的entry集合</p>
</li>
<li><p>ma_lookup：查找方法，hash查找方法，针对key类型有优化</p>
</li>
<li><p>ma_smalltable: 字典的伴生entries，entry集合的容量为8，初始化时就申请了内存</p>
</li>
</ul>
<p>PyDict_New</p>
<ol>
<li>查看缓冲池，重用或者新建</li>
<li>新建: smalltable清零; ma_table指向ma_smalltable; ma_used = ma_fill = 0，ma_mask = 7，ma_lookup默认使用lookdict_string</li>
</ol>
<p><img src="https://s2.ax1x.com/2019/03/04/kOhJbj.png" srcset="/img/loading.gif" alt="kOhJbj.png"></p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">DICT_MINISIZE = <span class="hljs-number">8</span><br>DUMMY = <span class="hljs-string">&quot;dummy&quot;</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PyDictEntry</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        self.me_hash = <span class="hljs-literal">None</span><br>        self.me_key = <span class="hljs-literal">None</span><br>        self.me_value = <span class="hljs-literal">None</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">if</span> self.me_value:<br>            s = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.me_key&#125;</span>-<span class="hljs-subst">&#123;self.me_value&#125;</span>&quot;</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;s:&lt;<span class="hljs-number">5</span>&#125;</span>&quot;</span><br>        <span class="hljs-keyword">elif</span> self.me_key:<br>            <span class="hljs-keyword">assert</span> self.me_key <span class="hljs-keyword">is</span> DUMMY<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;DUMMY&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;FREE &quot;</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PyDictObject</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span> <span class="hljs-comment"># 这里忽略了缓冲池，可以使用__new__来模拟</span><br>        self.ma_fill = <span class="hljs-number">0</span><br>        self.ma_used = <span class="hljs-number">0</span><br>        self.ma_mask = DICT_MINISIZE - <span class="hljs-number">1</span><br>        self.ma_smalltable = [PyDictEntry() <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(DICT_MINISIZE)]<br>        self.ma_table = self.ma_smalltable<br>        self.lookup = dict_lookup<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__getitem__</span>(<span class="hljs-params">self, key</span>):</span><br>        <span class="hljs-keyword">return</span> PyDict_GetItem(self, key)<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__setitem__</span>(<span class="hljs-params">self, key, value</span>):</span><br>        PyDict_SetItem(self, key ,value)<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__delitem__</span>(<span class="hljs-params">self, key</span>):</span><br>        PyDict_DelItem(self, key)<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">repr</span>(self.ma_table)<br>    <br><span class="hljs-comment"># PyDict_SetItem(dc, key, value)在容量伸缩部分补齐</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">PyDict_GetItem</span>(<span class="hljs-params">dc, key</span>):</span><br>    hashvalue = <span class="hljs-built_in">hash</span>(key)<br>    ep = dc.lookup(dc, key, hashvalue)<br>    <span class="hljs-keyword">if</span> ep.me_value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">raise</span> KeyError(key)<br>    <span class="hljs-keyword">return</span> ep.me_value<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">PyDict_DelItem</span>(<span class="hljs-params">dc, key</span>):</span><br>    dict_del(dc, key, <span class="hljs-built_in">hash</span>(key))<br></code></pre></div></td></tr></table></figure>
<h3 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h3><p>字典默认的是lookdict_string查找函数，这是一种针对key为string类型的字典做的优化。更通用的是lookdict版本，在key不是string的情况下工作。这里直接先看基础版本</p>
<p>沿着冲突链，寻找两种中止：1. 未使用的entry；2.key匹配的entry。期间如果遇到了dummy entry，设置freeslot，在返回未使用的entry时，优先返回freeslot代表的dummy entry，方便重用entry。所以两种中止条件，共三种返回状态，1、空entry (key=value=NULL)，2、dummy entry (key=DUMMY,value=NULL)，3、active entry (key\value均不为NULL）</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">DUMMY = <span class="hljs-string">&quot;dummy&quot;</span><br>        <br><span class="hljs-comment"># lookdict重命名为dict_lookup</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict_lookup</span>(<span class="hljs-params">dc, key, hashvalue</span>):</span><br>    freeslot = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> gen_probes(hashvalue, dc.ma_mask):<br>        entry = dc.ma_table[i]<br>        <span class="hljs-comment"># unused 直接返回</span><br>        <span class="hljs-keyword">if</span> entry.me_key <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span> entry <span class="hljs-keyword">if</span> freeslot <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> freeslot<br>        <span class="hljs-comment"># 冲突链上遇到的第一个墓碑，直接记下来，去下一个位置</span><br>        <span class="hljs-keyword">if</span> entry.me_key <span class="hljs-keyword">is</span> DUMMY:<br>            freeslot = entry<br>        <span class="hljs-comment"># 冲突链上有个好端端的key，所以检查一哈是不是我们想要的</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> (entry.me_key <span class="hljs-keyword">is</span> key <span class="hljs-keyword">or</span>  <span class="hljs-comment"># 引用相同</span><br>                entry.me_hash == hashvalue <span class="hljs-keyword">and</span>  <span class="hljs-comment"># 检查hash</span><br>                    entry.me_key == key):  <span class="hljs-comment"># 最后检查*最耗时*的相等检查</span><br>                <span class="hljs-keyword">return</span> entry<br></code></pre></div></td></tr></table></figure>
<p>再说回lookdict_string的优化问题。查找里的性能瓶颈就是在检查key是否是目标key。本来可以直接使用<code>entry.key == key</code>来判断，但是不同的类型的比较操作性能差别很大，能避免就避免，于是先比较引用、hash。而lookdict_string的优化就是直接是由字符串的比较，省得还去找类型的比较函数</p>
<h3 id="插入与删除"><a href="#插入与删除" class="headerlink" title="插入与删除"></a>插入与删除</h3><p>插入的想法是，先查找，三种返回状态，Active替换value，Dummy、空都要填充所用entry字段，并增加ma_used，注意空entry需要额外增加ma_fill</p>
<p>删除的想法是，先查找，三种返回状态，Active和变为Dummy，ma_used减少，空和Dummy就抛出KeyError</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict_insert</span>(<span class="hljs-params">dc, key, hashvalue, value</span>):</span><br>    entry = dc.lookup(dc, key, hashvalue)<br>    <span class="hljs-comment"># 正在使用的entry</span><br>    <span class="hljs-keyword">if</span> entry.me_value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        entry.me_value = value<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">if</span> entry.me_key <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:  <span class="hljs-comment"># 未被使用的entry</span><br>            dc.ma_fill += <span class="hljs-number">1</span><br>        entry.me_hash = hashvalue<br>        entry.me_key = key<br>        entry.me_value = value<br>        dc.ma_used += <span class="hljs-number">1</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict_del</span>(<span class="hljs-params">dc, key, hashvalue</span>):</span><br>    entry = dc.lookup(dc, key, hashvalue)<br>    <span class="hljs-keyword">if</span> entry.me_value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:  <span class="hljs-comment"># 空或者dummy，dummy出现在重复删除时</span><br>        <span class="hljs-keyword">raise</span> KeyError(key)<br>    <span class="hljs-keyword">else</span>:<br>        entry.me_key = DUMMY<br>        entry.me_hash = <span class="hljs-literal">None</span><br>        entry.me_value = <span class="hljs-literal">None</span><br>        dc.ma_used -= <span class="hljs-number">1</span> <br></code></pre></div></td></tr></table></figure>
<h3 id="容量伸缩"><a href="#容量伸缩" class="headerlink" title="容量伸缩"></a>容量伸缩</h3><p>字典的大小(ma_mask+1)必须为二次幂，而为了保证hash表的效率，使用过的entry应当是总体容量的2/3。也就是，当ma_fill超过(ma_size+1)的2/3，字典容量需要进行一次调整，调整的依据称为增长率</p>
<p>Python各版本的增长率如下表</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>growth rate</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.x ~ 3.2</td>
<td>active*4</td>
</tr>
<tr>
<td>3.3</td>
<td>active*2</td>
</tr>
<tr>
<td>3.4~3.6</td>
<td>active*2+capacity/2</td>
</tr>
<tr>
<td>3.7</td>
<td>active*3</td>
</tr>
</tbody>
</table>
<blockquote>
<p> 具体在2.x中还有一个考虑内存的经验判断，这里不妨忽略掉：</p>
<p> <code>growth_rate = ma_used * (2 if ma_used &gt; 50000 else 4)</code></p>
</blockquote>
<p>字典容量capacity，则是大于growth_rate的最小二次幂。</p>
<p>根据这些信息，我们可以做出下面这个图</p>
<p><img src="https://s2.ax1x.com/2019/03/05/kXt5ad.png" srcset="/img/loading.gif" alt="kXt5ad.png"></p>
<p>所以在3.2之前，有可能存在4倍扩容，而3.2之后，最大也就两倍扩容了。</p>
<p>注意中间3.4~3.6的那个奇怪的增长率，实际上是个<a target="_blank" rel="noopener" href="https://bugs.python.org/issue33205">bug</a>，它阻止字典容量变小。</p>
<p>什么时候检查这个临界点呢？插入数据的时候。如果确实插入了一个新的Active，并且满足容量边界触发条件，则开始resize。所以，<strong>删除字典entry的时候容量并不改变</strong>。</p>
<p>resize的想法是，按照新的容量，新申请table，复位字典的字段，然后把原有的active放到新table中。当然还要考虑到smalltable的重用</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">PyDict_SetItem</span>(<span class="hljs-params">dc, key, value</span>):</span><br>    hashvalue = <span class="hljs-built_in">hash</span>(key)<br>    n_used = dc.ma_used<br>    dict_insert(dc, key, hashvalue, value)<br>    <span class="hljs-keyword">if</span> dc.ma_used &gt; n_used <span class="hljs-keyword">and</span> dc.ma_fill*<span class="hljs-number">3</span> &gt;= (dc.ma_mask+<span class="hljs-number">1</span>)*<span class="hljs-number">2</span>:<br>        growth_rate = dc.ma_used * (<span class="hljs-number">2</span> <span class="hljs-keyword">if</span> dc.ma_used &lt; <span class="hljs-number">50000</span> <span class="hljs-keyword">else</span> <span class="hljs-number">4</span>)<br>        dict_resize(dc, growth_rate)<br>        <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict_resize</span>(<span class="hljs-params">dc, size</span>):</span><br>    <span class="hljs-comment"># ma_mask+1必须为二次幂</span><br>    print(<span class="hljs-string">&#x27;----resize-----&#x27;</span>)<br>    size = <span class="hljs-built_in">max</span>(DICT_MINISIZE, <span class="hljs-number">2</span> ** size.bit_length())<br>    old_table = dc.ma_table<br>    is_old_table_malloced = old_table <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> dc.ma_smalltable<br>    <span class="hljs-comment"># 容量减小，应该使用smalltable</span><br>    <span class="hljs-keyword">if</span> size == DICT_MINISIZE:<br>        new_table = dc.ma_smalltable<br>        <span class="hljs-comment"># 本来就是smalltable，还要resize，两种情况</span><br>        <span class="hljs-keyword">if</span> new_table <span class="hljs-keyword">is</span> old_table:<br>            <span class="hljs-comment"># 1.被内部代码强制resize了，什么都不做</span><br>            <span class="hljs-keyword">if</span> dc.ma_fill == dc.ma_used:<br>                <span class="hljs-keyword">return</span><br>            <span class="hljs-comment"># 2.存在删除操作</span><br>            <span class="hljs-comment"># 插入5个值，fill=used=5，删除，fill=5，used=0</span><br>            <span class="hljs-comment"># 再插入一个，fill=6, used=1, 触发resize，目的仅仅时删除dummy entry</span><br>            <span class="hljs-keyword">assert</span> dc.ma_fill &gt; dc.ma_used<br>            small_copy = deepcopy(old_table)<br>            old_table = small_copy  <span class="hljs-comment"># 此时new_table和old_table不再是同一个identity</span><br>    <span class="hljs-keyword">else</span>:<br>        new_table = [PyDictEntry() <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size)]<br><br>    <span class="hljs-comment"># 初始化新字典</span><br>    <span class="hljs-keyword">assert</span> new_table <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> old_table<br>    dc.ma_table = new_table<br>    dc.ma_mask = size - <span class="hljs-number">1</span><br>    dc.ma_used = <span class="hljs-number">0</span><br>    dc.ma_fill = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> entry <span class="hljs-keyword">in</span> new_table:<br>        entry.me_hash = entry.me_key = entry.me_value = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">for</span> entry <span class="hljs-keyword">in</span> old_table:<br>        <span class="hljs-keyword">if</span> entry.me_value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            dict_insert(dc, entry.me_key, entry.me_hash, entry.me_value)<br>        <span class="hljs-comment"># 剩下要么是未使用，要么是dummy</span><br>        <span class="hljs-keyword">elif</span> entry.me_key <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">assert</span> entry.me_key <span class="hljs-keyword">is</span> DUMMY<br><br>    <span class="hljs-keyword">if</span> is_old_table_malloced:<br>        <span class="hljs-keyword">del</span> old_table  <br></code></pre></div></td></tr></table></figure>
<h3 id="小测试"><a href="#小测试" class="headerlink" title="小测试"></a>小测试</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    d = PyDictObject()<br>    op_map = <span class="hljs-built_in">dict</span>(S=<span class="hljs-string">&#x27;__setitem__&#x27;</span>, G=<span class="hljs-string">&#x27;__getitem__&#x27;</span>, D=<span class="hljs-string">&#x27;__delitem__&#x27;</span>)<br>    operations = [<br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">0</span>]],   <span class="hljs-comment">#DUMMY</span><br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">1</span>,<span class="hljs-number">11</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">1</span>]],   <br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">2</span>, <span class="hljs-number">12</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">2</span>]],<br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">3</span>, <span class="hljs-number">13</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">3</span>]],<br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">4</span>, <span class="hljs-number">14</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">4</span>]],<br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">5</span>, <span class="hljs-number">15</span>]], <span class="hljs-comment"># fill到6，触发smalltable的resize</span><br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>]],<br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">11</span>]],<br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">2</span>, <span class="hljs-number">12</span>]],<br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">3</span>, <span class="hljs-number">13</span>]],<br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">4</span>, <span class="hljs-number">14</span>]],  <span class="hljs-comment"># 插入成功后触发resize</span><br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">6</span>, <span class="hljs-number">16</span>]],  <br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">0</span>]],<br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">16</span>, <span class="hljs-number">116</span>]], <span class="hljs-comment"># 0,1,6,15  0为DUMMY，1、6Active，15FREE，占用0DUMMY位</span><br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>]], <span class="hljs-comment"># 0,1,6,15  占15FREE位</span><br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">7</span>, <span class="hljs-number">17</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">7</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">6</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">0</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">5</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">4</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">3</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">2</span>]],<br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">1</span>]],<br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">8</span>, <span class="hljs-number">18</span>]],<br>        [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">9</span>, <span class="hljs-number">19</span>]], <span class="hljs-comment"># 触发容量变小的resize</span><br>        [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">999</span>]] <span class="hljs-comment"># let&#x27;s end up with error</span><br>    ]<br><br>    <span class="hljs-keyword">for</span> op <span class="hljs-keyword">in</span> operations:<br>        opt, opd = op<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-built_in">getattr</span>(d, op_map[opt])(*opd)<br>        <span class="hljs-keyword">except</span> KeyError <span class="hljs-keyword">as</span> e:<br>            print(<span class="hljs-built_in">repr</span>(e), e)<br>        <span class="hljs-keyword">if</span> opt <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>):<br>            print(d, d.ma_used, d.ma_fill)<br></code></pre></div></td></tr></table></figure>
<h2 id="中场休息·讨论"><a href="#中场休息·讨论" class="headerlink" title="中场休息·讨论"></a>中场休息·讨论</h2><ul>
<li><p>插入序</p>
<p>插入的(key，value)具体在ma_table中的哪一个位置，是hashvalue决定的，和插入的顺序无关。当迭代字典时，自然无法按照插入顺序返回entry</p>
</li>
<li><p>共享key</p>
<p>在最开始提到字典在Python中的一个典型应用，实例的attribute。大多数情况下，面向对象模式会在__init__里设置好实例字典里的key，而且之后较多更新而少增删。因此可以考虑在同一类型的实例中共享key，不同的实例维护不同的values就好。</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># legacy dictionary里是这样存的</span><br><br><span class="hljs-comment"># colors instance</span><br>ma_table = [[<span class="hljs-number">3086305163739458776</span>, <span class="hljs-string">&#x27;guido&#x27;</span>, <span class="hljs-string">&#x27;blue&#x27;</span>]，<br>    		[<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>],           <br>            [<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>],<br>            [<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>],<br>            [<span class="hljs-number">6038797773365358412</span>, <span class="hljs-string">&#x27;barry&#x27;</span>, <span class="hljs-string">&#x27;green&#x27;</span>],<br>            [<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>],<br>            [<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>],<br>            [<span class="hljs-number">8949987314752724126</span>, <span class="hljs-string">&#x27;timmy&#x27;</span>, <span class="hljs-string">&#x27;red&#x27;</span>]]<br><br><span class="hljs-comment"># fruits instance</span><br>ma_table = [[<span class="hljs-number">3086305163739458776</span>, <span class="hljs-string">&#x27;guido&#x27;</span>, <span class="hljs-string">&#x27;apple&#x27;</span>]，<br>    		[<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>],           <br>            [<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>],<br>            [<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>],<br>            [<span class="hljs-number">6038797773365358412</span>, <span class="hljs-string">&#x27;barry&#x27;</span>, <span class="hljs-string">&#x27;banana&#x27;</span>],<br>            [<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>],<br>            [<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>],<br>            [<span class="hljs-number">8949987314752724126</span>, <span class="hljs-string">&#x27;timmy&#x27;</span>, <span class="hljs-string">&#x27;cherry&#x27;</span>]]<br><br><span class="hljs-comment"># 共享keys的大小依然是二次幂，values的大小就可以是2/3</span><br>cached_keys = [<span class="hljs-number">2</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-number">0</span>]<br><span class="hljs-comment"># colors instance</span><br>values = [[<span class="hljs-number">8949987314752724126</span>, <span class="hljs-string">&#x27;timmy&#x27;</span>, <span class="hljs-string">&#x27;red&#x27;</span>],<br>          [<span class="hljs-number">6038797773365358412</span>, <span class="hljs-string">&#x27;barry&#x27;</span>, <span class="hljs-string">&#x27;green&#x27;</span>],<br>          [<span class="hljs-number">3086305163739458776</span>, <span class="hljs-string">&#x27;guido&#x27;</span>, <span class="hljs-string">&#x27;blue&#x27;</span>],<br>          [<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>],<br>          [<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>]]<br><br><span class="hljs-comment"># fruits instance</span><br>values = [[<span class="hljs-number">8949987314752724126</span>, <span class="hljs-string">&#x27;timmy&#x27;</span>, <span class="hljs-string">&#x27;cherry&#x27;</span>],<br>          [<span class="hljs-number">6038797773365358412</span>, <span class="hljs-string">&#x27;barry&#x27;</span>, <span class="hljs-string">&#x27;banana&#x27;</span>],<br>          [<span class="hljs-number">3086305163739458776</span>, <span class="hljs-string">&#x27;guido&#x27;</span>, <span class="hljs-string">&#x27;apple&#x27;</span>],<br>          [<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>],<br>          [<span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>, <span class="hljs-string">&#x27;--&#x27;</span>]]<br></code></pre></div></td></tr></table></figure>
<p>可以看到，将key和value分离，不仅在特定的场景下节约了内存，还保留了插入顺序。因为在单独的cached_keys中插入，角标递增，values天然满足插入序。沿着这个想法，对于那些普通的非实例字典，也可以采用key、value分离的思路来保证插入序，尽管节约内存空间这个目标可能无法实现了，因为这些字典并不共享key。</p>
</li>
</ul>
<p>接下来，就看看Python3.7中，具体是怎样分离key和value</p>
<h2 id="2-Compact-Dictionary"><a href="#2-Compact-Dictionary" class="headerlink" title="2. Compact Dictionary"></a>2. Compact Dictionary</h2><p>基于3.7实现。建议读3.7的源码，修了3.6的bug，而且整体流程也更加简洁。</p>
<h3 id="Combined-or-Splited"><a href="#Combined-or-Splited" class="headerlink" title="Combined or Splited"></a>Combined or Splited</h3><p>中场讨论知道，key-value分离有两种典型的应用场景，由此分为combined(不共享key)和splited(共享key)两种字典。这俩数据结构是同一套，只是在个别字段上存在区别。</p>
<p>然后把两种的区别总结如下：</p>
<table>
<thead>
<tr>
<th></th>
<th>combined-table</th>
<th>splited-table</th>
</tr>
</thead>
<tbody>
<tr>
<td>ma_values</td>
<td>NULL</td>
<td>不为NULL</td>
</tr>
<tr>
<td>dk_refcnt</td>
<td>=1</td>
<td>&gt;=1，&gt;1时表明key正在被多个实例共享</td>
</tr>
<tr>
<td>场景</td>
<td>普通显式字典</td>
<td>实例字典，容量为8，key为string类型</td>
</tr>
</tbody>
</table>
<p>关于Compact Dict的几个关键信息，参考<a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0412/">PEP412</a>，<a target="_blank" rel="noopener" href="https://bugs.python.org/issue28040">issue28040</a></p>
<ol>
<li>由dict()或{}语法创建的显式字典，一开始就是combined，永远不会转换为split。</li>
<li>当创建实例的__dict__字典时，会采用split-table，缓存到该类型里，可以让多个实例共享同样的key。当字典开始出现独立的变化，比如增加一个以数字为key的entry，或者破坏插入序(见第4点)，就会退化为combined-table </li>
<li>由于split-table的存在，诞生了一种新的Pending的状态</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># 1. Unused. 也被称为FREE、EMPTY </span><br><br><span class="hljs-comment"># 2. Active.  index &gt;= 0, me_key != NULL and value != NULL </span><br><span class="hljs-comment">#    注意这个value可能是dk_entries[index].me_value, 可能是ma_values[index]</span><br><br><span class="hljs-comment"># 3. Dummy.  index == DKIX_DUMMY  (combined only)</span><br>   <br><span class="hljs-comment"># 4. Pending. index &gt;= 0, key != NULL, and ma_values[index] == NULL  (split only)</span><br><span class="hljs-comment">#   Not yet inserted in split-table. </span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span>:</span><br>    <span class="hljs-keyword">pass</span><br><br>a, b = C(), C() <span class="hljs-comment"># a、b共享keys</span><br>a.attr1, a.attr2 = <span class="hljs-number">1</span>, <span class="hljs-number">2</span><br><span class="hljs-comment"># 现在b就有两个Pending状态的slot，attr1和attr2</span><br>b.attr1 = <span class="hljs-number">11</span>, b.attr2 = <span class="hljs-number">12</span>  <span class="hljs-comment"># b填充pending状态，依然共享key</span><br><span class="hljs-comment"># 但是如果先b.attr2=12，b.attr1 = 12, 11就会破坏插入序，b的字典转换为combine。</span><br><span class="hljs-comment"># 或者b.attr3=13也会造成字典转换为combine</span><br></code></pre></div></td></tr></table></figure>
<ol start="4">
<li><p>resize时，splited也会转变为combined。有一个例外：如下C类的实例字典，初始化时有6个值，会触发resize，但是因为仅一个实例(利用dk_refcnt判断)，会立马转换为splited</p>
<blockquote>
<p>PyDict_SetItem() may call dictresize and convert split table into combined table. In such case, convert it to split table again and update type’s shared key only when this is <strong>the only dict</strong> sharing key with the type.<br>This is to allow using shared key in class like this:    </p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span>:</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init</span>(<span class="hljs-params">self</span>):</span><br>  <span class="hljs-comment"># one dict resize happens</span><br>  self.a, self.b, self.c = <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span><br>  self.d, self.e, self.f = <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span><br>a = C()<br></code></pre></div></td></tr></table></figure>
</blockquote>
</li>
</ol>
<h3 id="数据结构-amp-初始化-1"><a href="#数据结构-amp-初始化-1" class="headerlink" title="数据结构 &amp; 初始化"></a>数据结构 &amp; 初始化</h3><p><img src="https://s2.ax1x.com/2019/03/06/kjOeCF.png" srcset="/img/loading.gif" alt="kjOeCF.png"></p>
<p>两个字典用的都基于相同数据结构，只是对各字段的使用有区别，如上图</p>
<p>PyDictKeyEntry</p>
<ul>
<li>me_hash</li>
<li>me_key</li>
<li>me_value</li>
</ul>
<p>这就是原来的PyDictEntry，名字中加Key，因为这里的entry被安置到下面要提及的Keys对象中</p>
<p>PyDictKeysObject</p>
<ul>
<li>dk_refcnt：当前Keys对象有多少个引用</li>
<li>dk_size：字典容量，二次幂，等效原来的(ma_mask+1)。现在mask用宏计算。</li>
<li>dk_lookup：查找函数，方便优化</li>
<li>dk_usable: 初始化为dk_size的2/3，减到0时就resize字典</li>
<li>dk_nentries: 等效原来的ma_fill，包含active和dummy</li>
<li>dk_indices: 索引数组，大小同dk_size</li>
<li>dk_entries: 这是紧随的一片地址，大小同dk_usable，安置entry，在C实现中没有直接指针，通过宏从dk_indices计算起始位置。split字典中每个entry的value都为NULL，因为它有专门的放置位置</li>
</ul>
<p>PyDictObject</p>
<ul>
<li>ma_used：正在使用entry，active</li>
<li>ma_version_tag：每次修改字典会打新tag，和细节优化有关，这里不管啦</li>
<li>ma_keys：PyDictKeysObject对象</li>
<li>ma_values: split字典的value存在这里，split字典时申请dk_usable大小的空间</li>
</ul>
<p>新版本里没有smalltable了，因为smalltable不支持splited-table形式，在combined-table中等效于dk_entries</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> itertools <span class="hljs-keyword">import</span> count<br><br>DICT_MINISIZE = <span class="hljs-number">8</span><br>FREE = -<span class="hljs-number">1</span><br>DUMMY = -<span class="hljs-number">2</span><br>DICT_NEXT_VERSION = count().__next__<br>SHARED_KEYS = <span class="hljs-literal">None</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">growth_rate</span>(<span class="hljs-params">dc</span>):</span><br>    <span class="hljs-keyword">return</span> dc.ma_used * <span class="hljs-number">3</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dk_entries_at</span>(<span class="hljs-params">dc, ix</span>):</span><br>    <span class="hljs-keyword">return</span> dc.ma_keys.dk_entries[ix]<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_is_splited_table</span>(<span class="hljs-params">dc</span>):</span><br>    <span class="hljs-keyword">return</span> dc.ma_values <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PyDictKeyEntry</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        self.me_hash = <span class="hljs-literal">None</span><br>        self.me_key = <span class="hljs-literal">None</span><br>        self.me_value = <span class="hljs-literal">None</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">if</span> self.me_key <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">if</span> self.me_value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                s = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.me_key&#125;</span>-<span class="hljs-subst">&#123;self.me_value&#125;</span>&quot;</span><br>            <span class="hljs-keyword">else</span>:<br>                s = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.me_key&#125;</span>-*&quot;</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;s:&lt;<span class="hljs-number">5</span>&#125;</span>&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;#    &quot;</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PyDictKeysObject</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, size</span>):</span><br>        self.dk_refcnt = <span class="hljs-number">1</span><br>        self.dk_size = size<br>        self.dk_lookup = dict_lookup<br>        self.dk_usable = (self.dk_size &lt;&lt; <span class="hljs-number">1</span>) // <span class="hljs-number">3</span><br>        self.dk_nentries = <span class="hljs-number">0</span><br>        self.dk_indices = [FREE]*self.dk_size<br>        self.dk_entries = [PyDictKeyEntry() <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.dk_usable)]<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">inv_match</span>(<span class="hljs-params">ix</span>):</span><br>            <span class="hljs-keyword">if</span> ix == -<span class="hljs-number">1</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;FREE &#x27;</span><br>            <span class="hljs-keyword">elif</span> ix == -<span class="hljs-number">2</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;DUMMY&#x27;</span><br>            <span class="hljs-keyword">else</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;ix:&lt;<span class="hljs-number">5</span>&#125;</span>&quot;</span><br>        visual_indices = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(inv_match, self.dk_indices))<br>        str_indices = <span class="hljs-string">f&quot;[<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;, &#x27;</span>.join(visual_indices)&#125;</span>]&quot;</span><br>        <span class="hljs-keyword">return</span> str_indices+<span class="hljs-string">&quot;\n&quot;</span>+<span class="hljs-built_in">repr</span>(self.dk_entries)<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PyDictObject</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, keys, values</span>):</span><br>        self.ma_used = <span class="hljs-number">0</span><br>        self.ma_version_tage = DICT_NEXT_VERSION()<br>        self.ma_keys = keys<br>        self.ma_values = values<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__getitem__</span>(<span class="hljs-params">self, key</span>):</span><br>        ix, _ = self.ma_keys.dk_lookup(self, key, <span class="hljs-built_in">hash</span>(key))<br>        <span class="hljs-keyword">if</span> ix &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> KeyError(key)<br>        <span class="hljs-keyword">if</span> _is_splited_table(self):<br>            <span class="hljs-keyword">return</span> self.ma_values[ix]<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> self.ma_keys.dk_entries[ix].me_value<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__setitem__</span>(<span class="hljs-params">self, key, value</span>):</span><br>        dict_insert(self, key, <span class="hljs-built_in">hash</span>(key), value) <br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__delitem__</span>(<span class="hljs-params">self, key</span>):</span><br>        dict_del(self, key, <span class="hljs-built_in">hash</span>(key))<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">if</span> _is_splited_table(self):<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">repr</span>(self.ma_keys)&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>(self.ma_keys)&#125;</span>\n<span class="hljs-subst">&#123;self.ma_values&#125;</span>&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">repr</span>(self.ma_keys)<br>        <br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict_factory</span>(<span class="hljs-params">kind</span>):</span><br>    <span class="hljs-keyword">if</span> kind == <span class="hljs-string">&#x27;combine&#x27;</span>:<br>        <span class="hljs-keyword">return</span> PyDictObject(PyDictKeysObject(DICT_MINISIZE), <span class="hljs-literal">None</span>)<br>    <span class="hljs-keyword">elif</span> kind == <span class="hljs-string">&#x27;split&#x27;</span>:<br>        <span class="hljs-keyword">global</span> SHARED_KEYS<br>        <span class="hljs-keyword">if</span> SHARED_KEYS <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            SHARED_KEYS = PyDictKeysObject(DICT_MINISIZE)<br>        <span class="hljs-keyword">else</span>:<br>            SHARED_KEYS.dk_refcnt += <span class="hljs-number">1</span><br>        values = [<span class="hljs-literal">None</span> <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(SHARED_KEYS.dk_usable)]<br>        <span class="hljs-keyword">return</span> PyDictObject(SHARED_KEYS, values)<br></code></pre></div></td></tr></table></figure>
<h3 id="查找-1"><a href="#查找-1" class="headerlink" title="查找"></a>查找</h3><p>这里查找的对象是dk_keys，一个数组，记录entry索引的那个，gen_probes没有变化</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict_lookup</span>(<span class="hljs-params">dc, key, hashvalue</span>):</span><br>    <span class="hljs-comment"># 因为分离的key和value，lookup返回实际上需要返回ix和pos</span><br>    <span class="hljs-comment"># ix是entry在dk_entries中的索引，pos是ix在dk_indices中的索引</span><br>    <span class="hljs-comment"># 3.6版本有freeslot，把pos由指针传出去</span><br>    <span class="hljs-comment"># 3.7版本没有freeslot，在需要的时候重新使用probe去获取pos</span><br>    <span class="hljs-comment"># 这里我们直接用python的tuple返回(ix, pos)</span><br>    <span class="hljs-comment"># 所以实际上还是返回了三种状态，free，dummy，匹配</span><br>    freeslot = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> gen_probes(hashvalue, dc.ma_keys.dk_size-<span class="hljs-number">1</span>):<br>        ix = dc.ma_keys.dk_indices[i]<br>        <span class="hljs-keyword">assert</span> ix &gt;= DUMMY<br>        <span class="hljs-comment"># unused 直接返回</span><br>        <span class="hljs-keyword">if</span> ix == FREE:<br>            <span class="hljs-keyword">return</span> (ix, i) <span class="hljs-keyword">if</span> freeslot <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> (DUMMY, freeslot)<br>        <span class="hljs-keyword">if</span> ix == DUMMY:<br>            freeslot = i<br>        <span class="hljs-comment"># ix &gt;= 0，所以检查一哈是不是我们想要的</span><br>        <span class="hljs-keyword">else</span>:<br>            entry = dk_entries_at(dc, ix)<br>            <span class="hljs-keyword">assert</span> entry.me_key <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>            <span class="hljs-keyword">if</span> (entry.me_key <span class="hljs-keyword">is</span> key <span class="hljs-keyword">or</span>  <span class="hljs-comment"># 引用相同</span><br>                entry.me_hash == hashvalue <span class="hljs-keyword">and</span>  <span class="hljs-comment"># 检查hash</span><br>                    entry.me_key == key):  <span class="hljs-comment"># 最后检查*最耗时*的相等检查</span><br>                <span class="hljs-keyword">return</span> (ix, i)<br>        <span class="hljs-comment"># key不对应，找下一个</span><br></code></pre></div></td></tr></table></figure>
<h3 id="插入与删除-1"><a href="#插入与删除-1" class="headerlink" title="插入与删除"></a>插入与删除</h3><p>这里把resize的逻辑放到了insert里面。</p>
<p>至于删除，主要要到把splited转变为combined再设置dummy的操作</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict_insert</span>(<span class="hljs-params">dc, key, hashvalue, value</span>):</span><br>    ix, pos = dc.ma_keys.dk_lookup(dc, key, hashvalue)<br><br>    <span class="hljs-keyword">if</span> _is_splited_table(dc):<br>        <span class="hljs-comment"># 如果插入的顺序不同，停止共享</span><br>        <span class="hljs-comment"># 第一种情况，插入已存在的key(Pending态)，但是不是按照最开始的插入序</span><br>        <span class="hljs-comment"># 第二种情况，插入了新的key-value</span><br>        <span class="hljs-keyword">if</span> (ix &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> dc.ma_values[ix] <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> dc.ma_used != ix<br>              <span class="hljs-keyword">or</span> ix == FREE <span class="hljs-keyword">and</span> dc.ma_used != dc.ma_keys.dk_nentries):<br>            print(<span class="hljs-string">&quot;--back to combine--&quot;</span>)<br>            dict_resize(dc, growth_rate(dc))<br><br>    <span class="hljs-comment"># 正在使用的entry</span><br>    <span class="hljs-keyword">if</span> ix &gt;= <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">if</span> _is_splited_table(dc):<br>            <span class="hljs-keyword">if</span> dc.ma_values[ix] <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-comment"># pending状态</span><br>                <span class="hljs-keyword">assert</span> ix == dc.ma_used<br>                dc.ma_used += <span class="hljs-number">1</span><br>            dc.ma_values[ix] = value<br>        <span class="hljs-keyword">else</span>:<br>            entry = dk_entries_at(dc, ix)<br>            <span class="hljs-keyword">assert</span> entry.value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>            entry.me_value = value<br>        dc.ma_version_tage = DICT_NEXT_VERSION()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># DUMMY或者FREE, 一定会增加一个key，value都是新鲜的active态，</span><br>        <span class="hljs-comment"># 等效于原来的ma_used+1检查</span><br>        <span class="hljs-comment"># 所以要检查一下字典大小，看是否resize</span><br>        <span class="hljs-comment"># </span><br>        <span class="hljs-keyword">if</span> dc.ma_keys.dk_usable &lt;= <span class="hljs-number">0</span>:<br>            dict_resize(dc, growth_rate(dc))<br>            <span class="hljs-comment"># 这句话C实现里没有，因为pos是按序去查找的</span><br>            ix, pos = dc.ma_keys.dk_lookup(dc, key, hashvalue)        <br>        <br>        <span class="hljs-comment"># 在没有保证插入序的时候，这里会检查是否为FREE，是，ma_fill才会+1，</span><br>        <span class="hljs-comment"># 这样就悄无声息地重用了被删除entry在ma_table中的位置</span><br>        <span class="hljs-comment"># 但是因为保证插入序，不能重用删除的entry在dk_entries中的位置</span><br>        <span class="hljs-comment"># ma_fill对标的dk_nentries无论FREE/DUMMY都会+1</span><br>        <span class="hljs-comment"># 重用的只能是删除key在dk_indices中的位置</span><br>        true_ix = dc.ma_keys.dk_nentries<br>        dc.ma_keys.dk_indices[pos] = true_ix <br>        <span class="hljs-comment"># 要插入的entry在dk_nentries处</span><br>        entry = dk_entries_at(dc, true_ix)<br><br>        entry.me_hash = hashvalue<br>        entry.me_key = key<br>        <span class="hljs-keyword">if</span> _is_splited_table(dc):<br>            <span class="hljs-keyword">assert</span> dc.ma_values[true_ix] <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span><br>            dc.ma_values[true_ix] = value<br>        <span class="hljs-keyword">else</span>:<br>            entry.me_value = value<br>        dc.ma_used += <span class="hljs-number">1</span><br>        dc.ma_version_tage = DICT_NEXT_VERSION()<br>        dc.ma_keys.dk_usable -= <span class="hljs-number">1</span><br>        dc.ma_keys.dk_nentries += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">assert</span> dc.ma_keys.dk_usable &gt;= <span class="hljs-number">0</span><br>        <br>        <br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict_del</span>(<span class="hljs-params">dc, key, hashvalue</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;只有combine支持删除，split也要先转换</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    ix, pos = dc.ma_keys.dk_lookup(dc, key, hashvalue)<br>    <span class="hljs-keyword">if</span> ix == FREE <span class="hljs-keyword">or</span> ix == DUMMY:<br>        <span class="hljs-keyword">raise</span> KeyError(key)<br>    <span class="hljs-keyword">if</span> _is_splited_table(dc):<br>        <span class="hljs-keyword">if</span> dc.ma_values[ix] <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>: <span class="hljs-comment">#pending状态</span><br>            <span class="hljs-keyword">raise</span> KeyError(key)<br>        <span class="hljs-comment"># resize一个相等大小的keys，-1因为使用了bit_length()</span><br>        print(<span class="hljs-string">&quot;----back to combine----&quot;</span>)<br>        dict_resize(dc, dc.ma_keys.dk_size-<span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># 因为pending的存在，resize重建indices可能造成ix, pos的变动</span><br>        ix, pos = dc.ma_keys.dk_lookup(dc, key, hashvalue)<br>        <span class="hljs-keyword">assert</span> ix &gt;= <span class="hljs-number">0</span> <span class="hljs-comment"># 一定能找到</span><br>    <br>    dc.ma_used -= <span class="hljs-number">1</span><br>    dc.ma_version_tage = DICT_NEXT_VERSION()<br>    dc.ma_keys.dk_indices[pos] = DUMMY<br>    entry = dk_entries_at(dc, ix)<br>    entry.me_key = <span class="hljs-literal">None</span><br>    entry.me_value = <span class="hljs-literal">None</span><br></code></pre></div></td></tr></table></figure>
<h3 id="容量伸缩-1"><a href="#容量伸缩-1" class="headerlink" title="容量伸缩"></a>容量伸缩</h3><p>不论split还是combine，resize的关键点要把握住，ma_used是连接前后的关键值。resize完成后，nentries和ma_used相等。流程先分类别处理两种字典的value，保证ma_used个值被转移到新字典里，然后再重建dk_indices</p>
<p>关于增长率，在之前讨论过。3.7改成了<code>active*3</code>，最多容量扩大一倍</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dict_resize</span>(<span class="hljs-params">dc, size</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    会把splited-table转变为combined-table，可以通过make_keys_shared转变回来</span><br><span class="hljs-string">    这就是在超过5个attr的实例字典初始化中要做的事情</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    print(<span class="hljs-string">&#x27;----resize-----&#x27;</span>)<br>    size = <span class="hljs-built_in">max</span>(DICT_MINISIZE, <span class="hljs-number">2</span> ** size.bit_length())<br>    old_keys = dc.ma_keys<br>    old_entries = old_keys.dk_entries<br>    <br>    dc.ma_keys = PyDictKeysObject(size)<br>    <span class="hljs-keyword">assert</span> dc.ma_keys.dk_usable &gt;= dc.ma_used<br><br>    <span class="hljs-keyword">if</span> _is_splited_table(dc):<br>        <span class="hljs-comment"># 转变为combine字典，把ma_values转移到dk_entries中</span><br>        <span class="hljs-comment"># split字典的ma_values一定密集，ma_used个值</span><br>        <span class="hljs-comment"># 小于等于dk_entries的个数，等于发生在没有pending时     </span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(dc.ma_used):<br>            <span class="hljs-keyword">assert</span> dc.ma_values[i] <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>            old_entry = old_entries[i]<br>            new_entry = dk_entries_at(dc, i)<br>            new_entry.me_key = old_entry.me_key<br>            new_entry.me_hash = old_entry.me_hash<br>            new_entry.me_value = dc.ma_values[i]<br>        <span class="hljs-comment"># KeysObject可能被其他实例对象引用，不能释放，仅释放ma_values</span><br>        <span class="hljs-keyword">del</span> dc.ma_values<br>        dc.ma_values = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># 总共需要向新的dk_entries塞入ma_used个值</span><br>        <span class="hljs-comment"># 不存在DUMMY，完全复制</span><br>        <span class="hljs-keyword">if</span> old_keys.dk_nentries == dc.ma_used:<br>            dc.ma_keys.dk_entries[:dc.ma_used] = old_entries[:dc.ma_used]<br>        <span class="hljs-comment"># 否则找出合格的ma_used个</span><br>        <span class="hljs-keyword">else</span>:<br>            active_entry = [<br>                entry <span class="hljs-keyword">for</span> entry <span class="hljs-keyword">in</span> old_entries <span class="hljs-keyword">if</span> entry.me_value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>]<br>            <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(active_entry) == dc.ma_used<br>            dc.ma_keys.dk_entries[:dc.ma_used] = active_entry<br>        <span class="hljs-comment"># 因为是combine的字典，KeysObject不会被其他引用，所以需要释放掉</span><br>        <span class="hljs-keyword">assert</span> old_keys.dk_refcnt == <span class="hljs-number">1</span><br>        <span class="hljs-keyword">del</span> old_entries<br>        <span class="hljs-keyword">del</span> old_keys<br><br>    <span class="hljs-comment"># 处理完entries和values，然后是根据密集的dk_entries重建dk_indices</span><br>    mask = size - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> ix, entry <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(dc.ma_keys.dk_entries[:dc.ma_used]):<br>        <span class="hljs-keyword">for</span> pos <span class="hljs-keyword">in</span> gen_probes(entry.me_hash, mask):<br>            <span class="hljs-keyword">if</span> dc.ma_keys.dk_indices[pos] == FREE: <span class="hljs-comment"># 不可能出现DUMMY</span><br>                dc.ma_keys.dk_indices[pos] = ix<br>                <span class="hljs-keyword">break</span><br>    dc.ma_keys.dk_usable -= dc.ma_used<br>    dc.ma_keys.dk_nentries = dc.ma_used<br></code></pre></div></td></tr></table></figure>
<h3 id="小测试-1"><a href="#小测试-1" class="headerlink" title="小测试"></a>小测试</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_tests</span>(<span class="hljs-params">d, operations</span>):</span><br>    op_map = <span class="hljs-built_in">dict</span>(S=<span class="hljs-string">&#x27;__setitem__&#x27;</span>, G=<span class="hljs-string">&#x27;__getitem__&#x27;</span>, D=<span class="hljs-string">&#x27;__delitem__&#x27;</span>)<br>    <span class="hljs-keyword">for</span> op <span class="hljs-keyword">in</span> operations:<br>        opt, opd = op<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-built_in">getattr</span>(d, op_map[opt])(*opd)<br>        <span class="hljs-keyword">except</span> KeyError <span class="hljs-keyword">as</span> e:<br>            print(<span class="hljs-built_in">repr</span>(e), e)<br>        <span class="hljs-keyword">if</span> opt <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;S&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>):<br>            print(d, d.ma_used, d.ma_keys.dk_nentries,<br>                  d.ma_keys.dk_usable, <span class="hljs-string">&#x27;\n&#x27;</span>)<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span> <br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &lt;= <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;combine&#x27;</span>:<br>        d = dict_factory(<span class="hljs-string">&#x27;combine&#x27;</span>)<br>        operations = [<br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">0</span>]],  <span class="hljs-comment"># DUMMY</span><br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">11</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">1</span>]],<br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">2</span>, <span class="hljs-number">12</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">2</span>]],<br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">3</span>, <span class="hljs-number">13</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">3</span>]],<br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">4</span>, <span class="hljs-number">14</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">4</span>]],<br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">5</span>, <span class="hljs-number">15</span>]],  <span class="hljs-comment"># fill到6，resize</span><br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>]],<br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">11</span>]],<br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">2</span>, <span class="hljs-number">12</span>]],<br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">3</span>, <span class="hljs-number">13</span>]],<br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">4</span>, <span class="hljs-number">14</span>]],  <span class="hljs-comment"># 插入成功后触发resize</span><br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">6</span>, <span class="hljs-number">16</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">0</span>]],<br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">16</span>, <span class="hljs-number">116</span>]],  <span class="hljs-comment"># 0,1,6,15  0为DUMMY，1、6Active，15FREE，占用0DUMMY位, </span><br>                               <span class="hljs-comment">#但是注意entries没有对应的那个</span><br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>]],    <span class="hljs-comment"># 0,1,6,15  占15FREE位</span><br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">7</span>, <span class="hljs-number">17</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">7</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">6</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">0</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">5</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">4</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">3</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">2</span>]],<br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">1</span>]],<br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">8</span>, <span class="hljs-number">18</span>]], <span class="hljs-comment"># 这里比原来版本提前一轮resize，就是因为没有重用entries，nentries一直增加</span><br>            [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">9</span>, <span class="hljs-number">19</span>]],  <br>            [<span class="hljs-string">&#x27;D&#x27;</span>, [<span class="hljs-number">999</span>]]  <span class="hljs-comment"># let&#x27;s end up with error</span><br>        ]<br>        run_tests(d, operations)<br><br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;split&#x27;</span>:<br>        d1 = dict_factory(<span class="hljs-string">&#x27;split&#x27;</span>)<br>        d2 = dict_factory(<span class="hljs-string">&#x27;split&#x27;</span>)<br>        run_tests(d1, [[<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">0</span>, <span class="hljs-number">10</span>]], [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">11</span>]]])<br>        run_tests(d2, [[<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">0</span>, <span class="hljs-number">20</span>]], [<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">21</span>]]])<br>        run_tests(d2, [[<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">2</span>, <span class="hljs-number">22</span>]]])<br>        <span class="hljs-comment"># 插入序改变，退化</span><br>        run_tests(d1, [[<span class="hljs-string">&#x27;S&#x27;</span>, [<span class="hljs-number">3</span>, <span class="hljs-number">13</span>]], [<span class="hljs-string">&#x27;S&#x27;</span>, (<span class="hljs-number">4</span>, <span class="hljs-number">14</span>)], [<span class="hljs-string">&#x27;D&#x27;</span>, (<span class="hljs-number">3</span>,)]]) <br>        <span class="hljs-comment"># 删除，也退化</span><br>        run_tests(d2, [[<span class="hljs-string">&#x27;D&#x27;</span>, (<span class="hljs-number">2</span>,)]])   <br></code></pre></div></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>Python字典的hash策略选择的是<strong>开放地址法</strong>，因为拉链法要维护额外的连接，比如链表的指针，开销更大。</li>
<li>开放地址法的冲突解决方案，总共有两步：<ol>
<li>找到一种基本的、人类生活中<strong>出现概率较小的索引序列</strong>，比如<code>idx = (5*idx+1) % 2**i</code></li>
<li>在基本序列基础上，每一步引入hashvalue的影响，以免hashvalue第一次确定的索引相同后，之后每次产生的新索引都相同(即<strong>探测链相同</strong>)</li>
</ol>
</li>
<li>装载率指，删除产生的空位entry(dummy)+正在使用的entry / 总的entry数量(二次幂)，装载率超过2/3时容量改变。注意删除key不会造成容量改变。</li>
<li>为什么3.6之后的字典能够保证插入序？因为keys和values分离了，想象keys，values都是列表，每次插入新值，values都按顺序写入值。即使发生删除，values中出现空位后，再插入值，新值也会按顺序出现在最后。探测链上的DUMMY值，只会出现在keys中，所以keys中因为删除出现的空位是可以被复用的。</li>
<li>字典的容量伸缩机制？字典的总容量(keys的大小)，一直都是二次幂，当装载率（active+dummy）超过容量的2/3，就会触发resize，调整总容量，重新分配新的内存，把因删除产生的dummy抹除。调整的总容量，目前3.7版本的一次调整，最多翻倍，最少可以回到8的初始值。</li>
<li>现在应该更能理解__slots__在做什么。一个实例字典，都要殚精竭虑地share key来减少内存使用。那么直接定义slots，让额外的__dict__消失岂不美滋滋？也就是《Fluent Python》中强调的，__slots__的本质就是减少内存，不是给你用来做限制的。</li>
<li>再黑魔法都是人写出来的，消除神秘感，也算是增强自己的信心，不要怕。一步一步做，他们也会写出bug啊。看Raymond的演讲，知道方案也是慢慢深入的，没有一步登天。</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Python/">Python</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2019/06/16/advent/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Advent of Code 2018 回顾</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-svg.js" ></script>

  








  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?69fdc2c3cb74b3ea985d8b632943139a";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->



</body>
</html>
