<!DOCTYPE html>
<html lang="zh-CN">










<head><meta name="generator" content="Hexo 3.8.0">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <link rel="apple-touch-icon" sizes="76x76" href="/howl.png">
    <link rel="icon" type="image/png" href="/howl.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="Is Life Always This Hard? / After all this time?">
    <meta name="author" content="aptend">
    <meta name="keywords" content>
    <title>Rustçº¿ç¨‹æ± æºç æ‹†è§£åŠå®ç° ~ No one</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.2/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/css/mdb.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1067060_vr10bjtg3us.css">
    
        <link rel="stylesheet" href="/css/Prettify/github.min.css">
    
    <link rel="stylesheet" href="/css/github-markdown.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
<div class="container">
    <a class="navbar-brand" href="/"><strong>No one</strong></a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto text-center">
            
            <li class="nav-item">
                <a class="nav-link" href="/">Home</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="/archives/">Archives</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" href="/about/">About</a>
            </li>
            
        </ul>
    </div>
</div>


</nav>
    <div class="view intro-2" style='background: url("https://i.imgur.com/oADD1Ip.jpg")no-repeat center center;background-size: cover;'>
    <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
        <div class="container text-center white-text wow fadeInUp">
            <p class="h2">Rustçº¿ç¨‹æ± æºç æ‹†è§£åŠå®ç°</p>
            <br>
            
            <p>Saturday, February 1st 2020, 10:49 pm</p>
            
        </div>
        </div>
    </div>
    </div>
  </header>

  <main>
  
  <div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2 ">
            <div class="markdown-body post-content py-5 z-depth-3 main">
                <p>çœ‹äº†rustçš„threadpool crateï¼Œç…§è™ç”»çŒ«ï¼</p>
<a id="more"></a>
<h2 id="åŸºæœ¬æ¨¡å‹"><a href="#åŸºæœ¬æ¨¡å‹" class="headerlink" title="åŸºæœ¬æ¨¡å‹"></a>åŸºæœ¬æ¨¡å‹</h2><p>åŸºæœ¬æ¨¡å‹æ˜¯ï¼Œå­˜åœ¨ä¸€ä¸ªä»»åŠ¡channelï¼Œå‘é€å¤´åœ¨<code>ThreadPool</code>é‡Œï¼Œé€šè¿‡<code>execute</code>æ–¹æ³•å‘é€ä»»åŠ¡é—­åŒ…ï¼Œå·²åˆå§‹åŒ–çš„è‹¥å¹²ä¸ªå·¥ä½œçº¿ç¨‹ä¸€ç›´å¤„åœ¨loopé‡Œï¼Œè¡Œä¸ºæ˜¯ä»ä»»åŠ¡é€šé“é‡Œå–ä»»åŠ¡ï¼Œæ‰§è¡Œï¼Œå–ä»»åŠ¡â€¦â€¦è¿™æ ·å¾ªç¯ã€‚å› ä¸ºæœ‰loopï¼Œæ‰€ä»¥çº¿ç¨‹å°±ä¸€ç›´æ²¡é€€å‡ºï¼Œå…å»äº†å›æ”¶ã€å†åˆ›å»ºçš„æ¶ˆè€—ã€‚</p>
<p><img src="https://s2.ax1x.com/2020/02/01/1JFENj.png" alt="threadpool.png"></p>
<p>ä»»åŠ¡é—­åŒ…ç­¾åä¸º<code>FnOnce() + Send + &#39;static</code>ï¼Œæ²¡æœ‰å‚æ•°ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥éœ€è¦å¯¹çœŸå®çš„è°ƒç”¨å‡½æ•°åšé€‚é…ï¼Œæ•è·å‚æ•°ï¼Œæ„é€ é—­åŒ…ï¼Œå¦‚æœæœ‰è¿”å›å€¼å°±ç›´æ¥ç”¨å…±äº«çš„å˜é‡æ”¶é›†ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·ï¼Œæ¯ä¸ªä»»åŠ¡æ˜¯äº§ç”Ÿè¾“å…¥å‚æ•°çš„å¹³æ–¹æ•°ï¼Œç»“æœæ”¶é›†åˆ°<code>Vec</code>é‡Œ</p>
<pre><code class="rust">fn do_something(i: usize) -&gt; usize {
    thread::sleep(Duration::from_micros(50 * i as u64));
    i * i
}

fn main() {
    let pool = ThreadPool::new(4);
    let ans = Arc::new(Mutex::new(Vec::&lt;usize&gt;::new()));
    for i in 0..10 {
        let ans = ans.clone();
        let job = move || {
            let result = do_something(i);
            (*ans.lock().unwrap()).push(result);
        };
        pool.execute(job)
    }
    pool.join();
    assert_eq!(285usize, (*ans.lock().unwrap()).iter().sum());
}
</code></pre>
<h2 id="æ­å»ºéª¨æ¶"><a href="#æ­å»ºéª¨æ¶" class="headerlink" title="æ­å»ºéª¨æ¶"></a>æ­å»ºéª¨æ¶</h2><p>ä»»åŠ¡é—­åŒ…ç”¨Boxè£…ç®±æ¥ä¼ æŒ‡é’ˆï¼ŒåŠ¨æ€æŸ¥æ‰¾è™½ç„¶æœ‰æ€§èƒ½æŸè€—ï¼Œä½†æ˜¯é—­åŒ…ç»“æ„çš„å¤åˆ¶æ¶ˆè€—ä¹Ÿç›¸å¯¹å›ºå®šï¼Œå…å¾—æœ‰ä¸ªä»€ä¹ˆå¤§é—­åŒ…ç»“æ„è¢«è«åå¤åˆ¶åˆ°çº¿ç¨‹æ ˆä¸Šã€‚</p>
<pre><code class="rust">type Job = Box&lt;dyn FnOnce() + Send + &#39;static&gt;;
</code></pre>
<p>åˆå§‹åŒ–ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªchannelçš„æ¥æ”¶ç«¯åŠ é”ï¼Œä¼ ç»™çº¿ç¨‹ï¼ŒåŒæ­¥åœ°ä»channelä¸­æ‹¿å‡ºä»»åŠ¡æ¥æ‰§è¡Œã€‚<code>Mutex</code>åŠ é”ï¼Œ<code>Arc</code>åˆ›å»ºå…±äº«æ‰€æœ‰æƒã€‚</p>
<pre><code class="rust">fn spawn_in_pool(receiver: Arc&lt;Mutex&lt;Receiver&lt;Job&gt;&gt;&gt;) {
    thread::spawn(move || loop {
        let recv_result = {
            // ä»¥æœ€å°‘æ—¶é—´å ç”¨é”
            receiver.lock().expect(&quot;can&#39;t lock channel receiver&quot;).recv()
        };

        let job_fn = match recv_result {
            Ok(job) =&gt; job,
            Err(_) =&gt; break, // è¿™ä¸ªé”™è¯¯è¯´æ˜å¦ä¸€ç«¯å·²ç»dropï¼Œé€€å‡ºè¯¥çº¿ç¨‹å°±å¯ä»¥
        };
        job_fn();
    });
}
</code></pre>
<p><code>ThreadPool</code>ç°åœ¨åªè¦ä¸€ä¸ªchannelçš„ä¼ è¾“å…¥å£ï¼Œç”¨äºä»»åŠ¡å‘é€ã€‚</p>
<pre><code class="rust">struct ThreadPool {
    sender: Sender&lt;Job&gt;,
}

impl ThreadPool {
    ...
    fn execute&lt;F&gt;(&amp;self, f: F)
    where
        F: FnOnce() + Send + &#39;static,
    {
        self.sender.send(Box::new(f)).unwrap();
    }
    ...    
}
</code></pre>
<p>åˆå§‹åŒ–å·¥ä½œè‡ªç„¶å°±æ˜¯è¦å»ºç«‹èµ·ä»»åŠ¡channelï¼Œç„¶åè°ƒç”¨<code>spawn_in_pool</code>ï¼Œåˆå§‹åŒ–è¦æ±‚ä¸ªæ•°çš„å·¥ä½œçº¿ç¨‹</p>
<pre><code class="rust">impl ThreadPool {
    fn new(threads_num: usize) -&gt; ThreadPool {
        let (tx, rx) = channel::&lt;Job&gt;(); // å»ºchannel
        let receiver = Arc::new(Mutex::new(rx)); // åˆå§‹åŒ–å·¥ä½œçº¿ç¨‹
        for _ in 0..threads_num {
            let receiver = receiver.clone();
            spawn_in_pool(receiver);
        }
        ThreadPool { sender: tx }  // è¿”å›pool
    }
}
</code></pre>
<p><code>join</code>ä½œç”¨å°±ç­‰å¾…å·¥ä½œçº¿ç¨‹å®Œæˆå…¨éƒ¨ä»»åŠ¡ï¼Œè¿™ä¸ªäº‹æƒ…ä¸‹é˜¶æ®µæ¥åšï¼Œè¿™é‡Œå…ˆéšä¾¿<code>sleep</code>æ›¿ä»£ä¸€ä¸‹ï¼Œèƒ½é€šè¿‡æµ‹è¯•ç”¨ä¾‹å°±å¯ä»¥ã€‚</p>
<pre><code class="rust">impl ThreadPool {
    fn join(&amp;self) {
        println!(&quot;waiting...&quot;);
        thread::sleep(Duration::from_secs(2));
    }
}
</code></pre>
<p>å¾ˆå¥½ï¼Œæµ‹è¯•é€šè¿‡ï¼ğŸ‰ğŸ‰ğŸ‰ğŸ‰çº¿ç¨‹æ± å†™å®Œäº†ï¼è†¨èƒ€å¾—å…ˆå»åƒä¸ªçƒ§çƒ¤åº†ç¥ä¸€ä¸‹ï¼</p>
<h2 id="æ­£ç¡®åœ°join"><a href="#æ­£ç¡®åœ°join" class="headerlink" title="æ­£ç¡®åœ°join"></a>æ­£ç¡®åœ°join</h2><p>ä»€ä¹ˆæ—¶å€™è¯´æ˜ä»»åŠ¡æ‰§è¡Œå®Œäº†ï¼Ÿ</p>
<ul>
<li>ä»»åŠ¡é˜Ÿåˆ—ä»»åŠ¡è®¡æ•°ä¸º0ï¼Œè®°ä¸º<code>queue_cnt == 0</code></li>
<li>æ²¡æœ‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œè®°ä¸º<code>active_cnt == 0</code></li>
</ul>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å…±äº«è¿™ä¸¤ä¸ªå˜é‡ç»™æ‰€æœ‰å·¥ä½œçº¿ç¨‹ã€‚å·¥ä½œçº¿ç¨‹å–å‡ºä¸€ä¸ªä»»åŠ¡ï¼Œ<code>queue_cnt -= 1</code>ï¼Œæ‰§è¡Œä»»åŠ¡å‰<code>active_cnt += 1</code>ï¼Œå®Œæˆå<code>active_cnt -= 1</code>ã€‚æ˜¾ç„¶<code>ThreadPool</code>ä¹Ÿéœ€è¦å…±äº«è¿™ä¸¤ä¸ªå˜é‡ï¼Œ<code>execute</code>æ—¶<code>queue_cnt += 1</code>ã€‚</p>
<p><code>join</code>æ—¶ï¼Œå¯ä»¥ç®€å•ç²—æš´åœ°è½®è¯¢è¿™äº›ä¸¤ä¸ªå˜é‡åˆ¤æ–­ã€‚ä½†æ˜¯è¿™ç§é€šçŸ¥çš„åŒæ­¥åœºæ™¯ï¼Œä½¿ç”¨æ¡ä»¶å˜é‡æ¥æŒ‚èµ·ç­‰å¾…çº¿ç¨‹ï¼Œæœ‰äº‹ä»¶æ—¶é‡å¯çº¿ç¨‹æ›´é«˜æ•ˆã€‚</p>
<p>è°åœ¨ç­‰å¾…ï¼Ÿ<code>join</code>æ–¹æ³•ï¼Œä½¿ç”¨æ¡ä»¶å˜é‡çš„<code>wait</code>æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾…äº‹ä»¶å‘ç”Ÿã€‚</p>
<p>è°æ¥é€šçŸ¥ï¼Ÿå·¥ä½œçº¿ç¨‹ï¼Œå½“å®Œæˆä¸€ä¸ªä»»åŠ¡åï¼Œæ£€æŸ¥ä»»åŠ¡æ˜¯å¦å…¨éƒ¨å®Œæˆï¼Œå¦‚æœæ˜¯ï¼Œå°±<code>notify_all</code>ï¼ˆå› ä¸º<code>ThreadPool</code>ä¹Ÿå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹é‡Œå¹¶å‘åœ°å‘é€ä»»åŠ¡ï¼‰ã€‚</p>
<p>æ‰€ä»¥ç°åœ¨è¦å…±äº«çš„å˜é‡åˆå¤šäº†4ä¸ªï¼Œåªèƒ½å•ç‹¬å†™ä¸€ä¸ªç»“æ„æ¥å°è£…ä»–ä»¬ï¼Œç„¶åå…±äº«ç»™å·¥ä½œçº¿ç¨‹ã€‚å¯¹äº<code>queue_cnt</code>ï¼Œ<code>active_cnt</code>è¿™ç§åŸºæœ¬ç±»å‹ï¼Œæœ‰<code>AtomicXxx</code>ç­‰åŸå­ç±»å‹ä¾›é€‰æ‹©ï¼Œä½†æ˜¯å†…å­˜é¡ºåºæš‚æ—¶è¿˜æ²¡çœ‹æ‡‚ï¼Œå…ˆç”¨<code>Mutex</code>ä»£æ›¿å§ï¼Œæ€§èƒ½ä½ç‚¹å°±ä½ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œç›´æ¥æŠŠåˆ¤æ–­å’Œé€šçŸ¥çš„æ–¹æ³•å®ç°åœ¨è¿™ä¸ª<code>SharedData</code>é‡Œã€‚</p>
<p>æ¡ä»¶å˜é‡å’Œäº’æ–¥é”é…å¥—ä½¿ç”¨ï¼Œäº’æ–¥é”çš„åŸºæœ¬ä½œç”¨æ˜¯ï¼Œå¯¹æ¡ä»¶å˜é‡çš„æ“ä½œï¼Œæ— è®ºæ˜¯<code>wait</code>ã€<code>notify_*</code>ï¼Œéƒ½æ˜¯äº’æ–¥è¿›è¡Œçš„ï¼Œä¿è¯æ¡ä»¶å˜é‡åœ¨å¢åŠ ã€ç§»é™¤æš‚åœçº¿ç¨‹æ—¶çš„å®‰å…¨æ€§ï¼Œå¦å¤–äº’æ–¥é”æœ¬èº«ä¹Ÿå¯ä»¥æºå¸¦ä¿¡æ¯ï¼Œä½œä¸ºæ¡ä»¶åˆ¤æ–­çš„å¯¹è±¡ã€‚ä½†æ˜¯è¿™ä¸ªé‡Œçš„<code>cond_guard</code>åªèµ·ç¬¬ä¸€ä¸ªä½œç”¨ï¼Œæ¡ä»¶çš„åˆ¤æ–­ç”±<code>queue_cnt</code>å’Œ<code>active_cnt</code>æ‰¿æ‹…ã€‚</p>
<pre><code class="rust">struct SharedData {
    receiver: Mutex&lt;Receiver&lt;Job&gt;&gt;,
    queue_cnt: Mutex&lt;usize&gt;,
    active_cnt: Mutex&lt;usize&gt;,
    cond_guard: Mutex&lt;()&gt;,
    cond: Condvar,
}

impl SharedData {
    fn has_task(&amp;self) -&gt; bool {
        *self.queue_cnt.lock().expect(&quot;can&#39;t lock queue_cnt&quot;) &gt; 0
            || *self.active_cnt.lock().expect(&quot;can&#39;t lock active_cnt&quot;) &gt; 0
    }

    fn notify_when_no_tasks(&amp;self) {
        if !self.has_task() {
            *self.cond_guard.lock().expect(&quot;can&#39;t lock cond_guard&quot;);
            self.cond.notify_all(); // ç‹¬å åœ°é€šçŸ¥
        }
    }
}
</code></pre>
<p>æ¥ä¸‹æ¥å°±æ˜¯å›´ç»•è¿™ä¸ªæ–°çš„ä¸­é—´ç»“æ„ï¼Œæ”¹é€ ä¹‹å‰çš„éª¨æ¶å°±å¯ä»¥ï¼Œæ¯”å¦‚<code>spawn_in_pool</code>çš„è¦æ”¹ç­¾åï¼Œå¢åŠ å˜é‡ç»´æŠ¤çš„é€»è¾‘ã€‚</p>
<pre><code class="rust">fn spawn_in_pool(data: Arc&lt;SharedData&gt;) {
    // ...å–å‡ºä»»åŠ¡
    {
         *data.queue_cnt.lock().expect(&quot;can&#39;t lock queue_cnt&quot;) -= 1;
    }
    {
        *data.active_cnt.lock().expect(&quot;can&#39;t lock queue_cnt&quot;) += 1;
    }
    job_fn();
    {
        *data.active_cnt.lock().expect(&quot;can&#39;t lock queue_cnt&quot;) -= 1;
    }

    data.notify_when_no_tasks();
}
</code></pre>
<p><code>ThreadPool</code>æœ¬èº«ä¹Ÿå¤šäº†ä¸€ä¸ª<code>data</code>å­—æ®µï¼Œæ–¹ä¾¿<code>join</code>ã€<code>execute</code>æ—¶ä½¿ç”¨</p>
<pre><code class="rust">struct ThreadPool {
    sender: Sender&lt;Job&gt;,
    data: Arc&lt;SharedData&gt;,
}

impl ThreadPool {
    fn new(threads_num: usize) -&gt; ThreadPool {
        let (tx, rx) = channel::&lt;Job&gt;();
        let data = Arc::new(SharedData {
            receiver: Mutex::new(rx),
            queue_cnt: Mutex::new(0),
            active_cnt: Mutex::new(0),
            cond_guard: Mutex::new(()),
            cond: Condvar::new(),
        });

        for _ in 0..threads_num {
            let data = data.clone();
            spawn_in_pool(data);
        }
        ThreadPool {
            sender: tx,
            data: data,
        }
    }

    fn execute&lt;F&gt;(&amp;self, f: F)
    where
        F: FnOnce() + Send + &#39;static,
    {
        {
            *self.data.queue_cnt.lock().expect(&quot;can&#39;t lock queue_cnt&quot;) += 1;
        }
        self.sender.send(Box::new(f)).unwrap();
    }

    fn join(&amp;self) {
        if !self.data.has_task() { // ä¸€ä¸ªå°ä¼˜åŒ–ï¼Œæœ‰æœºä¼šé¿å…ä¸€æ¬¡cond_guardçš„åŠ é”
            return;
        }
        let mut guard = self.data.cond_guard.lock().expect(&quot;can&#39;t lock cond guard&quot;);
        while self.data.has_task() {
            guard = self.data.cond.wait(guard).unwrap();
        }
    }
}
</code></pre>
<p>ğŸ®ğŸºï¼Œæµ‹è¯•é€šè¿‡ï¼ğŸ‰ğŸ‰ğŸ‰ğŸ‰é˜¶æ®µæ€§æˆæœï¼æˆåŠŸå®Œæˆäº†æ­£å¸¸å·¥ä½œçš„<code>join</code></p>
<h2 id="åŠ¨æ€è®¾ç½®å·¥ä½œçº¿ç¨‹æ•°"><a href="#åŠ¨æ€è®¾ç½®å·¥ä½œçº¿ç¨‹æ•°" class="headerlink" title="åŠ¨æ€è®¾ç½®å·¥ä½œçº¿ç¨‹æ•°"></a>åŠ¨æ€è®¾ç½®å·¥ä½œçº¿ç¨‹æ•°</h2><p>çº¿ç¨‹æ± åˆ›å»ºä¹‹åï¼Œå¦‚æœæƒ³è¦åŠ¨æ€å¢åŠ æˆ–è€…å‡å°‘çº¿ç¨‹æ•°é‡å¯å’‹æï¼Ÿåˆ†ä¸¤ç§æƒ…å†µæ¥è€ƒè™‘ã€‚</p>
<ol>
<li>å·¥ä½œçº¿ç¨‹æ•°å¢åŠ ï¼Œå·®å¤šå°‘ä¸ªï¼Œå°±è°ƒç”¨å¤šå°‘æ¬¡<code>spawn_in_pool</code>ï¼Œè¡¥é½å·®è·ã€‚</li>
<li>å·¥ä½œçº¿ç¨‹å‡å°‘ï¼Œé‚£å°±è¦è®©ä¸€äº›å·¥ä½œçº¿ç¨‹è‡ªåŠ¨åœ°breakï¼Œé€€å‡ºåè‡ªåŠ¨è¢«å›æ”¶ã€‚æ€ä¹ˆè®©è¿™äº›å¤šä½™çš„çº¿ç¨‹çŸ¥é“è‡ªå·±è¢«ä¸‹å²—äº†å‘¢ï¼Ÿç°åœ¨æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ä¸èƒ½åŠ¨ï¼Œé‚£äº›æ‰§è¡Œå®Œï¼Œå†æ¬¡å¾ªç¯å»å·¥ä½œé˜Ÿåˆ—é‡Œæ‹¿ä»»åŠ¡å‰ï¼Œå°±å¯ä»¥æ£€æŸ¥å¤šå°‘çº¿ç¨‹æ­£åœ¨å·¥ä½œ<code>active_cnt</code>ï¼Œå¦‚æœå¤§äºè®¾å®šçš„æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆè‡ªå·±å°±ä¸»åŠ¨é€€å‡ºã€‚</li>
</ol>
<p>æ‰€ä»¥æ€è·¯å°±æ˜¯</p>
<ul>
<li>åœ¨<code>SharedData</code>é‡Œå¢åŠ ä¸€ä¸ª<code>max_threads_cnt</code>å­—æ®µï¼›</li>
<li>ç»™<code>ThreadPool</code>å®ç°<code>set_threads_num</code>æ–¹æ³•ï¼Œå¦‚æœæ˜¯å¢åŠ ï¼Œå°±è°ƒç”¨<code>spawn_in_pool</code>è¡¥é½ï¼›</li>
<li>å·¥ä½œçº¿ç¨‹çš„æ¯æ¬¡å–ä»»åŠ¡å‰éƒ½æ£€æŸ¥ä¸€ä¸‹<code>active_cnt</code>æ˜¯å¦å¤§äº<code>max_threads_cnt</code>ï¼Œæ˜¯å°±breakï¼›</li>
</ul>
<p>åä¸¤ç‚¹å˜åŠ¨çš„ä»£ç æ˜¯</p>
<pre><code class="rust">impl ThreadPool {
    // ...
    fn set_threads_num(&amp;self, size: usize) {
        let mut prev_cnt = size;
        {
            let mut p_thread_cnt = self
                .data
                .max_threads_cnt
                .lock()
                .expect(&quot;can&#39;t lock max_threads_cnt&quot;);
            prev_cnt = *p_thread_cnt;
            *p_thread_cnt = size;
        }
        if let Some(n) = size.checked_sub(prev_cnt) {
            for _ in 0..n {
                let data = self.data.clone();
                spawn_in_pool(data);
            }
        }
    }
}


fn spawn_in_pool(data: Arc&lt;SharedData&gt;) {
    {
        if *data.active_cnt.lock().unwrap() &gt;= *data.max_threads_cnt.lock().unwrap() {
            break
        }
    }
    // ...å–å‡ºä»»åŠ¡
}
</code></pre>
<h2 id="å·¥ä½œçº¿ç¨‹panicæ€ä¹ˆåŠ"><a href="#å·¥ä½œçº¿ç¨‹panicæ€ä¹ˆåŠ" class="headerlink" title="å·¥ä½œçº¿ç¨‹panicæ€ä¹ˆåŠ"></a>å·¥ä½œçº¿ç¨‹panicæ€ä¹ˆåŠ</h2><p>å¦‚æœä»»åŠ¡é—­åŒ…<code>job_fn</code>æ‰§è¡Œäº§ç”Ÿäº†panicï¼Œé‚£ä¹ˆä¼šäº§ç”Ÿä»€ä¹ˆå½±å“ï¼Ÿé¦–å…ˆæ˜¯çº¿ç¨‹é€€å‡º</p>
<ul>
<li>çº¿ç¨‹é€€å‡ºï¼Œå·¥ä½œçº¿ç¨‹ä¸ç­‰äºå½“åˆè®¾å®šçš„çº¿ç¨‹æ•°</li>
<li><code>job_fn</code>åé¢çš„ä»£ç æ²¡æœ‰æ‰§è¡Œï¼š<code>active_cnt</code>æ²¡æœ‰å‡ä¸€ã€æ²¡æœ‰é€šçŸ¥<code>join</code></li>
</ul>
<p>æ‰€ä»¥å› panicé€€å‡ºæ—¶ï¼Œå¾—æ‰§è¡Œè¢«è·³è¿‡çš„é€»è¾‘ï¼Œå¹¶ä¸”é‡å¯çº¿ç¨‹ã€‚</p>
<p>panicé€€å‡ºæ—¶è¿˜è¦æ‰§è¡Œä»£ç ï¼Ÿè¿™å’‹åŠå‘¢ï¼Œåªèƒ½æ˜¯æŸä¸ªç»“æ„å®ç°<code>Drop</code>traitï¼Œåœ¨<code>drop</code>æ–¹æ³•ä¸­æ‰§è¡Œæ²¡æœ‰æ‰§è¡Œå®Œçš„é€»è¾‘ã€‚ä¸‹é¢æ˜¯æºç ä¸­<code>Sentinel</code>å“¨å…µçš„å®ç°ã€‚</p>
<pre><code class="rust">impl&lt;&#39;a&gt; Sentinel&lt;&#39;a&gt; {
    // åœ¨å·¥ä½œçº¿ç¨‹è¿›å…¥loopå‰ï¼Œnewä¸€ä¸ªæ–°é²œçš„sentinel
    fn new(shared_data: &amp;&#39;a Arc&lt;ThreadPoolSharedData&gt;) -&gt; Sentinel&lt;&#39;a&gt; {
        Sentinel {
            shared_data: shared_data,
            active: true,
        }
    }

    /// loopæ­£å¸¸breakå‡ºæ¥ï¼Œæ‰§è¡Œcancel.
    fn cancel(mut self) {
        self.active = false;
    }
}

impl&lt;&#39;a&gt; Drop for Sentinel&lt;&#39;a&gt; {
    fn drop(&amp;mut self) {
        if self.active { // è¯´æ˜ä¸æ˜¯breakæ­£å¸¸é€€å‡º
            self.shared_data.active_count.fetch_sub(1, Ordering::SeqCst);
            if thread::panicking() { 
                self.shared_data.panic_count.fetch_add(1, Ordering::SeqCst);
            }
            self.shared_data.no_work_notify_all();
            spawn_in_pool(self.shared_data.clone())
        }
    }
}
</code></pre>
<p>ç„¶åæˆ‘çš„ç–‘é—®æ˜¯ï¼šä¸ºä»€ä¹ˆä¼šæœ‰å“¨å…µçš„<code>active</code>å­—æ®µå’Œ<code>thread::panicking()</code>çš„åŒé‡æ£€æŸ¥ï¼Ÿéæ­£å¸¸é€€å‡ºé™¤äº†panicè¿˜æœ‰å…¶ä»–çš„æƒ…å†µï¼Ÿå¦‚æœæ˜¯å…¶ä»–æƒ…å†µï¼Œä¸ºä»€ä¹ˆè¿›å…¥activeåˆ†æ”¯åç›´æ¥å¯¹<code>active_cnt</code>è¿›è¡Œå‡1æ“ä½œï¼Œè¿™ä¸ªæ“ä½œçš„æ½œåœ¨å‡è®¾æ˜¯é€»è¾‘æµä¸€å®šä¸­æ­¢äºé—­åŒ…è°ƒç”¨å‘€ï¼Œé‚£ä¹ˆé™¤äº†<code>job_fn</code>æœ¬èº«panicï¼Œè¿˜èƒ½æœ‰ä»€ä¹ˆå¯èƒ½æ»¡è¶³è¿™ä¸ªå‡è®¾å‘¢ï¼Ÿæˆ‘è¿˜è¯•è¿‡äº†ï¼Œæºä»£ç å®ç°ä¸­ï¼Œå¦‚æœè·å–è·å–å·¥ä½œé˜Ÿåˆ—é”å¤±è´¥ï¼Œ<code>expect</code>äº§ç”Ÿçš„panicä¹Ÿä¼šè¿›å…¥<code>drop</code>æ–¹æ³•ï¼Œé€ æˆ<code>active_count</code>å‡1åæº¢å‡ºï¼Œè¡Œä¸ºå®Œå…¨å¤±æ§ã€‚</p>
<p>æˆ‘ä¸ªäººçœ‹æ³•ï¼Œæ­£ç¡®çš„è§£å†³åŠæ³•ï¼Œåº”è¯¥æ˜¯<code>drop</code>åªåº”å¯¹ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯ä»»åŠ¡é—­åŒ…panicï¼Œè¿™æ˜¯å”¯ä¸€ä¸å¯æ§çš„ä»£ç ï¼Œå…¶ä»–æƒ…å†µå¦‚æœå‡ºç°errorï¼Œå°±åœ°å¤„ç†ï¼Œæ¯”å¦‚å·¥ä½œé˜Ÿåˆ—è·å–é”ï¼Œå¦‚æœå¤±è´¥ï¼Œæ ‡è®°sentinelçš„<code>drop</code>ä¸è¦å¤„ç†ï¼Œä¸»åŠ¨<code>spand_in_pool</code>æŒ½æ•‘ã€‚åƒæˆ‘è¿™é‡Œæ²¡æœ‰ä½¿ç”¨<code>AtomicXxx</code>ï¼Œè·å–çŠ¶æ€å­—æ®µæ—¶å‡ºé”™ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸¥é‡çš„è¿è¡Œæ—¶é—®é¢˜ï¼Œå·²ç»æ— æ³•ç»´æŒçº¿ç¨‹æ± çš„æ­£ç¡®çŠ¶æ€ï¼Œä¹Ÿæ˜¯æ ‡è®°<code>drop</code>ä¸è¦å¤„ç†ï¼ŒåŒæ—¶æ ‡è®°çº¿ç¨‹æ± åœæ­¢å·¥ä½œï¼ŒæŠ›å‡ºpanicã€‚</p>
<h2 id="è¿˜æœ‰ä»€ä¹ˆå¯ä»¥åšçš„å—ï¼Ÿ"><a href="#è¿˜æœ‰ä»€ä¹ˆå¯ä»¥åšçš„å—ï¼Ÿ" class="headerlink" title="è¿˜æœ‰ä»€ä¹ˆå¯ä»¥åšçš„å—ï¼Ÿ"></a>è¿˜æœ‰ä»€ä¹ˆå¯ä»¥åšçš„å—ï¼Ÿ</h2><ul>
<li>ç°åœ¨å¼‚å¸¸åªä¼šè®¡æ•°ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç»™æ¯ä¸ªä»»åŠ¡å¢åŠ åå­—ï¼Œjoinä¹‹åå¯ä»¥é‡æ–°æ‰§è¡Œå¤±è´¥çš„ä»»åŠ¡ï¼Ÿ</li>
<li>ä»»åŠ¡è¶…æ—¶æ€ä¹ˆåŠï¼Ÿ<code>ThreadPool</code>ç»“æ„å°±å¾—ä¸»åŠ¨æ€æ­»çº¿ç¨‹ï¼Œæ‰€ä»¥è¿˜å¾—å…±äº«ä¸€ä¸ª&lt;çº¿ç¨‹id-çŠ¶æ€&gt;çš„æ˜ å°„ï¼Ÿ</li>
<li>æŠŠå·¥ä½œé˜Ÿåˆ—çš„æ€§è´¨ä¹Ÿåšæˆåˆå§‹åŒ–å‚æ•°ï¼Ÿç”¨æˆ·å¯ä»¥é€‰æ‹©ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—å’Œæ— ç•Œé˜Ÿåˆ—ï¼Ÿ</li>
<li>å·¥ä½œçº¿ç¨‹panicçš„é—®é¢˜ï¼Œè¿˜å¾…ç¡®è®¤è§£å†³æ–¹æ¡ˆã€‚</li>
<li>æºä»£ç ä¸­çš„<code>test_threads_num_decreasing</code>æµ‹è¯•ç”¨ä¾‹æœ‰è¯¯ï¼Œç¬¬äºŒæ¬¡<code>execute</code>çš„æ•°é‡åº”è¯¥å¤šäº<code>new_threads_num</code></li>
</ul>
<p>OKï¼Œçº¿ç¨‹æ± çš„æºç è§£æå°±åˆ°è¿™é‡Œå§ï¼ŒæŒºæœ‰æ”¶è·çš„</p>
<ol>
<li>ç»ˆäºæ˜ç™½äº†çº¿ç¨‹æ± çš„æ¨¡å‹ï¼ŒåŸæ¥æ˜¯é˜Ÿåˆ—+å¤šä¸ªloopçº¿ç¨‹ğŸ‘</li>
<li>ç†Ÿæ‚‰äº†rustä¸­çš„çº¿ç¨‹åŒæ­¥å·¥å…·ã€‚ç®—æ˜¯å¯¹<a href="https://limpet.net/mbrubeck/2019/02/07/rust-a-unique-perspective.html" target="_blank" rel="noopener"><code>Unique+Share</code></a>è§’åº¦çš„å¤ä¹ ï¼Œè¿™ä¸ªè§’åº¦æ€è€ƒçœŸçš„éå¸¸æœ‰ç”¨ï¼<code>Arc</code>ã€<code>Mutex</code>å•¥çš„çœ‹å¾—æ›´æ¸…æ¥šäº†ã€‚</li>
</ol>

                <hr>
                <div>
                    <p>
                         
                        <span class="badge badge-light">#&nbsp;Rust</span>
                        &nbsp;
                        
                    </p>
                </div>
                <br>
                
            </div>
        </div>
        <div class="d-none d-md-block col-md-2">
            
  <div id="toc" class="py-5">
    <!-- <p class="h6"><i class="iconfont icon-toc" style="vertical-align:middle"></i> Toc:</p>  -->
    <div id="tocbot"></div>
  </div>


        </div>
    </div>        
</div>

<br><br><br>

<!-- Comments -->
<div class="comments" id="comments">
 
</div>

  
  </main>

<footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank"><b>HEXO</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/0x2e/Material-T" target="_blank"> <b>Material-T</b></a>
  </div>
</footer>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/jquery-3.3.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.7.4/js/mdb.min.js"></script>
<script src="/js/main.js"></script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>

<script src="/js/post.js"></script>

<script src="/js/plugins/prettify.js"></script>
<script>
  $(document).ready(function () {
    $('pre').addClass('prettyprint');
    prettyPrint();
  })
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
    });
</script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


</body>
</html>