

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/howl.jpg">
  <link rel="icon" type="image/png" href="/img/howl.jpg">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="Is Life Always This Hard? / After all this time?">
  <meta name="author" content="aptend">
  <meta name="keywords" content="">
  <title>Rustçº¿ç¨‹æ± æºç æ‹†è§£åŠå®ç° - No one</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"aptend.com","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":"69fdc2c3cb74b3ea985d8b632943139a","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>No one</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg/post.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Rustçº¿ç¨‹æ± æºç æ‹†è§£åŠå®ç°">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-02-01 22:49" pubdate>
        February 1, 2020 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.7k å­—
    </span>
  

  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Rustçº¿ç¨‹æ± æºç æ‹†è§£åŠå®ç°</h1>
            
            <div class="markdown-body">
              <p>çœ‹äº†rustçš„threadpool crateï¼Œç…§è™ç”»çŒ«ï¼</p>
<a id="more"></a>
<h2 id="åŸºæœ¬æ¨¡å‹"><a href="#åŸºæœ¬æ¨¡å‹" class="headerlink" title="åŸºæœ¬æ¨¡å‹"></a>åŸºæœ¬æ¨¡å‹</h2><p>åŸºæœ¬æ¨¡å‹æ˜¯ï¼Œå­˜åœ¨ä¸€ä¸ªä»»åŠ¡channelï¼Œå‘é€å¤´åœ¨<code>ThreadPool</code>é‡Œï¼Œé€šè¿‡<code>execute</code>æ–¹æ³•å‘é€ä»»åŠ¡é—­åŒ…ï¼Œå·²åˆå§‹åŒ–çš„è‹¥å¹²ä¸ªå·¥ä½œçº¿ç¨‹ä¸€ç›´å¤„åœ¨loopé‡Œï¼Œè¡Œä¸ºæ˜¯ä»ä»»åŠ¡é€šé“é‡Œå–ä»»åŠ¡ï¼Œæ‰§è¡Œï¼Œå–ä»»åŠ¡â€¦â€¦è¿™æ ·å¾ªç¯ã€‚å› ä¸ºæœ‰loopï¼Œæ‰€ä»¥çº¿ç¨‹å°±ä¸€ç›´æ²¡é€€å‡ºï¼Œå…å»äº†å›æ”¶ã€å†åˆ›å»ºçš„æ¶ˆè€—ã€‚</p>
<p><img src="https://s2.ax1x.com/2020/02/01/1JFENj.png" srcset="/img/loading.gif" alt="threadpool.png"></p>
<p>ä»»åŠ¡é—­åŒ…ç­¾åä¸º<code>FnOnce() + Send + &#39;static</code>ï¼Œæ²¡æœ‰å‚æ•°ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥éœ€è¦å¯¹çœŸå®çš„è°ƒç”¨å‡½æ•°åšé€‚é…ï¼Œæ•è·å‚æ•°ï¼Œæ„é€ é—­åŒ…ï¼Œå¦‚æœæœ‰è¿”å›å€¼å°±ç›´æ¥ç”¨å…±äº«çš„å˜é‡æ”¶é›†ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·ï¼Œæ¯ä¸ªä»»åŠ¡æ˜¯äº§ç”Ÿè¾“å…¥å‚æ•°çš„å¹³æ–¹æ•°ï¼Œç»“æœæ”¶é›†åˆ°<code>Vec</code>é‡Œ</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">do_something</span></span>(i: <span class="hljs-built_in">usize</span>) -&gt; <span class="hljs-built_in">usize</span> &#123;<br>    thread::sleep(Duration::from_micros(<span class="hljs-number">50</span> * i <span class="hljs-keyword">as</span> <span class="hljs-built_in">u64</span>));<br>    i * i<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() &#123;<br>    <span class="hljs-keyword">let</span> pool = ThreadPool::new(<span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">let</span> ans = Arc::new(Mutex::new(<span class="hljs-built_in">Vec</span>::&lt;<span class="hljs-built_in">usize</span>&gt;::new()));<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">10</span> &#123;<br>        <span class="hljs-keyword">let</span> ans = ans.clone();<br>        <span class="hljs-keyword">let</span> job = <span class="hljs-keyword">move</span> || &#123;<br>            <span class="hljs-keyword">let</span> result = do_something(i);<br>            (*ans.lock().unwrap()).push(result);<br>        &#125;;<br>        pool.execute(job)<br>    &#125;<br>    pool.join();<br>    <span class="hljs-built_in">assert_eq!</span>(<span class="hljs-number">285usize</span>, (*ans.lock().unwrap()).iter().sum());<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h2 id="æ­å»ºéª¨æ¶"><a href="#æ­å»ºéª¨æ¶" class="headerlink" title="æ­å»ºéª¨æ¶"></a>æ­å»ºéª¨æ¶</h2><p>ä»»åŠ¡é—­åŒ…ç”¨Boxè£…ç®±æ¥ä¼ æŒ‡é’ˆï¼ŒåŠ¨æ€æŸ¥æ‰¾è™½ç„¶æœ‰æ€§èƒ½æŸè€—ï¼Œä½†æ˜¯é—­åŒ…ç»“æ„çš„å¤åˆ¶æ¶ˆè€—ä¹Ÿç›¸å¯¹å›ºå®šï¼Œå…å¾—æœ‰ä¸ªä»€ä¹ˆå¤§é—­åŒ…ç»“æ„è¢«è«åå¤åˆ¶åˆ°çº¿ç¨‹æ ˆä¸Šã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Job</span></span> = <span class="hljs-built_in">Box</span>&lt;<span class="hljs-keyword">dyn</span> <span class="hljs-built_in">FnOnce</span>() + <span class="hljs-built_in">Send</span> + <span class="hljs-symbol">&#x27;static</span>&gt;;<br></code></pre></div></td></tr></table></figure>
<p>åˆå§‹åŒ–ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªchannelçš„æ¥æ”¶ç«¯åŠ é”ï¼Œä¼ ç»™çº¿ç¨‹ï¼ŒåŒæ­¥åœ°ä»channelä¸­æ‹¿å‡ºä»»åŠ¡æ¥æ‰§è¡Œã€‚<code>Mutex</code>åŠ é”ï¼Œ<code>Arc</code>åˆ›å»ºå…±äº«æ‰€æœ‰æƒã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">spawn_in_pool</span></span>(receiver: Arc&lt;Mutex&lt;Receiver&lt;Job&gt;&gt;&gt;) &#123;<br>    thread::spawn(<span class="hljs-keyword">move</span> || <span class="hljs-keyword">loop</span> &#123;<br>        <span class="hljs-keyword">let</span> recv_result = &#123;<br>            <span class="hljs-comment">// ä»¥æœ€å°‘æ—¶é—´å ç”¨é”</span><br>            receiver.lock().expect(<span class="hljs-string">&quot;can&#x27;t lock channel receiver&quot;</span>).recv()<br>        &#125;;<br><br>        <span class="hljs-keyword">let</span> job_fn = <span class="hljs-keyword">match</span> recv_result &#123;<br>            <span class="hljs-literal">Ok</span>(job) =&gt; job,<br>            <span class="hljs-literal">Err</span>(_) =&gt; <span class="hljs-keyword">break</span>, <span class="hljs-comment">// è¿™ä¸ªé”™è¯¯è¯´æ˜å¦ä¸€ç«¯å·²ç»dropï¼Œé€€å‡ºè¯¥çº¿ç¨‹å°±å¯ä»¥</span><br>        &#125;;<br>        job_fn();<br>    &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><code>ThreadPool</code>ç°åœ¨åªè¦ä¸€ä¸ªchannelçš„ä¼ è¾“å…¥å£ï¼Œç”¨äºä»»åŠ¡å‘é€ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ThreadPool</span></span> &#123;<br>    sender: Sender&lt;Job&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span> ThreadPool &#123;<br>    ...<br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">execute</span></span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, f: F)<br>    <span class="hljs-keyword">where</span><br>        F: <span class="hljs-built_in">FnOnce</span>() + <span class="hljs-built_in">Send</span> + <span class="hljs-symbol">&#x27;static</span>,<br>    &#123;<br>        <span class="hljs-keyword">self</span>.sender.send(<span class="hljs-built_in">Box</span>::new(f)).unwrap();<br>    &#125;<br>    ...    <br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>åˆå§‹åŒ–å·¥ä½œè‡ªç„¶å°±æ˜¯è¦å»ºç«‹èµ·ä»»åŠ¡channelï¼Œç„¶åè°ƒç”¨<code>spawn_in_pool</code>ï¼Œåˆå§‹åŒ–è¦æ±‚ä¸ªæ•°çš„å·¥ä½œçº¿ç¨‹</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> ThreadPool &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">new</span></span>(threads_num: <span class="hljs-built_in">usize</span>) -&gt; ThreadPool &#123;<br>        <span class="hljs-keyword">let</span> (tx, rx) = channel::&lt;Job&gt;(); <span class="hljs-comment">// å»ºchannel</span><br>        <span class="hljs-keyword">let</span> receiver = Arc::new(Mutex::new(rx)); <span class="hljs-comment">// åˆå§‹åŒ–å·¥ä½œçº¿ç¨‹</span><br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..threads_num &#123;<br>            <span class="hljs-keyword">let</span> receiver = receiver.clone();<br>            spawn_in_pool(receiver);<br>        &#125;<br>        ThreadPool &#123; sender: tx &#125;  <span class="hljs-comment">// è¿”å›pool</span><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><code>join</code>ä½œç”¨å°±ç­‰å¾…å·¥ä½œçº¿ç¨‹å®Œæˆå…¨éƒ¨ä»»åŠ¡ï¼Œè¿™ä¸ªäº‹æƒ…ä¸‹é˜¶æ®µæ¥åšï¼Œè¿™é‡Œå…ˆéšä¾¿<code>sleep</code>æ›¿ä»£ä¸€ä¸‹ï¼Œèƒ½é€šè¿‡æµ‹è¯•ç”¨ä¾‹å°±å¯ä»¥ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> ThreadPool &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">join</span></span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;waiting...&quot;</span>);<br>        thread::sleep(Duration::from_secs(<span class="hljs-number">2</span>));<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>å¾ˆå¥½ï¼Œæµ‹è¯•é€šè¿‡ï¼ğŸ‰ğŸ‰ğŸ‰ğŸ‰çº¿ç¨‹æ± å†™å®Œäº†ï¼è†¨èƒ€å¾—å…ˆå»åƒä¸ªçƒ§çƒ¤åº†ç¥ä¸€ä¸‹ï¼</p>
<h2 id="æ­£ç¡®åœ°join"><a href="#æ­£ç¡®åœ°join" class="headerlink" title="æ­£ç¡®åœ°join"></a>æ­£ç¡®åœ°join</h2><p>ä»€ä¹ˆæ—¶å€™è¯´æ˜ä»»åŠ¡æ‰§è¡Œå®Œäº†ï¼Ÿ</p>
<ul>
<li>ä»»åŠ¡é˜Ÿåˆ—ä»»åŠ¡è®¡æ•°ä¸º0ï¼Œè®°ä¸º<code>queue_cnt == 0</code></li>
<li>æ²¡æœ‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œè®°ä¸º<code>active_cnt == 0</code></li>
</ul>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å…±äº«è¿™ä¸¤ä¸ªå˜é‡ç»™æ‰€æœ‰å·¥ä½œçº¿ç¨‹ã€‚å·¥ä½œçº¿ç¨‹å–å‡ºä¸€ä¸ªä»»åŠ¡ï¼Œ<code>queue_cnt -= 1</code>ï¼Œæ‰§è¡Œä»»åŠ¡å‰<code>active_cnt += 1</code>ï¼Œå®Œæˆå<code>active_cnt -= 1</code>ã€‚æ˜¾ç„¶<code>ThreadPool</code>ä¹Ÿéœ€è¦å…±äº«è¿™ä¸¤ä¸ªå˜é‡ï¼Œ<code>execute</code>æ—¶<code>queue_cnt += 1</code>ã€‚</p>
<p><code>join</code>æ—¶ï¼Œå¯ä»¥ç®€å•ç²—æš´åœ°è½®è¯¢è¿™äº›ä¸¤ä¸ªå˜é‡åˆ¤æ–­ã€‚ä½†æ˜¯è¿™ç§é€šçŸ¥çš„åŒæ­¥åœºæ™¯ï¼Œä½¿ç”¨æ¡ä»¶å˜é‡æ¥æŒ‚èµ·ç­‰å¾…çº¿ç¨‹ï¼Œæœ‰äº‹ä»¶æ—¶é‡å¯çº¿ç¨‹æ›´é«˜æ•ˆã€‚</p>
<p>è°åœ¨ç­‰å¾…ï¼Ÿ<code>join</code>æ–¹æ³•ï¼Œä½¿ç”¨æ¡ä»¶å˜é‡çš„<code>wait</code>æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾…äº‹ä»¶å‘ç”Ÿã€‚</p>
<p>è°æ¥é€šçŸ¥ï¼Ÿå·¥ä½œçº¿ç¨‹ï¼Œå½“å®Œæˆä¸€ä¸ªä»»åŠ¡åï¼Œæ£€æŸ¥ä»»åŠ¡æ˜¯å¦å…¨éƒ¨å®Œæˆï¼Œå¦‚æœæ˜¯ï¼Œå°±<code>notify_all</code>ï¼ˆå› ä¸º<code>ThreadPool</code>ä¹Ÿå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹é‡Œå¹¶å‘åœ°å‘é€ä»»åŠ¡ï¼‰ã€‚</p>
<p>æ‰€ä»¥ç°åœ¨è¦å…±äº«çš„å˜é‡åˆå¤šäº†4ä¸ªï¼Œåªèƒ½å•ç‹¬å†™ä¸€ä¸ªç»“æ„æ¥å°è£…ä»–ä»¬ï¼Œç„¶åå…±äº«ç»™å·¥ä½œçº¿ç¨‹ã€‚å¯¹äº<code>queue_cnt</code>ï¼Œ<code>active_cnt</code>è¿™ç§åŸºæœ¬ç±»å‹ï¼Œæœ‰<code>AtomicXxx</code>ç­‰åŸå­ç±»å‹ä¾›é€‰æ‹©ï¼Œä½†æ˜¯å†…å­˜é¡ºåºæš‚æ—¶è¿˜æ²¡çœ‹æ‡‚ï¼Œå…ˆç”¨<code>Mutex</code>ä»£æ›¿å§ï¼Œæ€§èƒ½ä½ç‚¹å°±ä½ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œç›´æ¥æŠŠåˆ¤æ–­å’Œé€šçŸ¥çš„æ–¹æ³•å®ç°åœ¨è¿™ä¸ª<code>SharedData</code>é‡Œã€‚</p>
<p>æ¡ä»¶å˜é‡å’Œäº’æ–¥é”é…å¥—ä½¿ç”¨ï¼Œäº’æ–¥é”çš„åŸºæœ¬ä½œç”¨æ˜¯ï¼Œå¯¹æ¡ä»¶å˜é‡çš„æ“ä½œï¼Œæ— è®ºæ˜¯<code>wait</code>ã€<code>notify_*</code>ï¼Œéƒ½æ˜¯äº’æ–¥è¿›è¡Œçš„ï¼Œä¿è¯æ¡ä»¶å˜é‡åœ¨å¢åŠ ã€ç§»é™¤æš‚åœçº¿ç¨‹æ—¶çš„å®‰å…¨æ€§ï¼Œå¦å¤–äº’æ–¥é”æœ¬èº«ä¹Ÿå¯ä»¥æºå¸¦ä¿¡æ¯ï¼Œä½œä¸ºæ¡ä»¶åˆ¤æ–­çš„å¯¹è±¡ã€‚ä½†æ˜¯è¿™ä¸ªé‡Œçš„<code>cond_guard</code>åªèµ·ç¬¬ä¸€ä¸ªä½œç”¨ï¼Œæ¡ä»¶çš„åˆ¤æ–­ç”±<code>queue_cnt</code>å’Œ<code>active_cnt</code>æ‰¿æ‹…ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SharedData</span></span> &#123;<br>    receiver: Mutex&lt;Receiver&lt;Job&gt;&gt;,<br>    queue_cnt: Mutex&lt;<span class="hljs-built_in">usize</span>&gt;,<br>    active_cnt: Mutex&lt;<span class="hljs-built_in">usize</span>&gt;,<br>    cond_guard: Mutex&lt;()&gt;,<br>    cond: Condvar,<br>&#125;<br><br><span class="hljs-keyword">impl</span> SharedData &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">has_task</span></span>(&amp;<span class="hljs-keyword">self</span>) -&gt; <span class="hljs-built_in">bool</span> &#123;<br>        *<span class="hljs-keyword">self</span>.queue_cnt.lock().expect(<span class="hljs-string">&quot;can&#x27;t lock queue_cnt&quot;</span>) &gt; <span class="hljs-number">0</span><br>            || *<span class="hljs-keyword">self</span>.active_cnt.lock().expect(<span class="hljs-string">&quot;can&#x27;t lock active_cnt&quot;</span>) &gt; <span class="hljs-number">0</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">notify_when_no_tasks</span></span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">if</span> !<span class="hljs-keyword">self</span>.has_task() &#123;<br>            *<span class="hljs-keyword">self</span>.cond_guard.lock().expect(<span class="hljs-string">&quot;can&#x27;t lock cond_guard&quot;</span>);<br>            <span class="hljs-keyword">self</span>.cond.notify_all(); <span class="hljs-comment">// ç‹¬å åœ°é€šçŸ¥</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>æ¥ä¸‹æ¥å°±æ˜¯å›´ç»•è¿™ä¸ªæ–°çš„ä¸­é—´ç»“æ„ï¼Œæ”¹é€ ä¹‹å‰çš„éª¨æ¶å°±å¯ä»¥ï¼Œæ¯”å¦‚<code>spawn_in_pool</code>çš„è¦æ”¹ç­¾åï¼Œå¢åŠ å˜é‡ç»´æŠ¤çš„é€»è¾‘ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">spawn_in_pool</span></span>(data: Arc&lt;SharedData&gt;) &#123;<br>    <span class="hljs-comment">// ...å–å‡ºä»»åŠ¡</span><br>    &#123;<br>         *data.queue_cnt.lock().expect(<span class="hljs-string">&quot;can&#x27;t lock queue_cnt&quot;</span>) -= <span class="hljs-number">1</span>;<br>    &#125;<br>    &#123;<br>        *data.active_cnt.lock().expect(<span class="hljs-string">&quot;can&#x27;t lock queue_cnt&quot;</span>) += <span class="hljs-number">1</span>;<br>    &#125;<br>    job_fn();<br>    &#123;<br>        *data.active_cnt.lock().expect(<span class="hljs-string">&quot;can&#x27;t lock queue_cnt&quot;</span>) -= <span class="hljs-number">1</span>;<br>    &#125;<br><br>    data.notify_when_no_tasks();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><code>ThreadPool</code>æœ¬èº«ä¹Ÿå¤šäº†ä¸€ä¸ª<code>data</code>å­—æ®µï¼Œæ–¹ä¾¿<code>join</code>ã€<code>execute</code>æ—¶ä½¿ç”¨</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ThreadPool</span></span> &#123;<br>    sender: Sender&lt;Job&gt;,<br>    data: Arc&lt;SharedData&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span> ThreadPool &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">new</span></span>(threads_num: <span class="hljs-built_in">usize</span>) -&gt; ThreadPool &#123;<br>        <span class="hljs-keyword">let</span> (tx, rx) = channel::&lt;Job&gt;();<br>        <span class="hljs-keyword">let</span> data = Arc::new(SharedData &#123;<br>            receiver: Mutex::new(rx),<br>            queue_cnt: Mutex::new(<span class="hljs-number">0</span>),<br>            active_cnt: Mutex::new(<span class="hljs-number">0</span>),<br>            cond_guard: Mutex::new(()),<br>            cond: Condvar::new(),<br>        &#125;);<br><br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..threads_num &#123;<br>            <span class="hljs-keyword">let</span> data = data.clone();<br>            spawn_in_pool(data);<br>        &#125;<br>        ThreadPool &#123;<br>            sender: tx,<br>            data: data,<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">execute</span></span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, f: F)<br>    <span class="hljs-keyword">where</span><br>        F: <span class="hljs-built_in">FnOnce</span>() + <span class="hljs-built_in">Send</span> + <span class="hljs-symbol">&#x27;static</span>,<br>    &#123;<br>        &#123;<br>            *<span class="hljs-keyword">self</span>.data.queue_cnt.lock().expect(<span class="hljs-string">&quot;can&#x27;t lock queue_cnt&quot;</span>) += <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">self</span>.sender.send(<span class="hljs-built_in">Box</span>::new(f)).unwrap();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">join</span></span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">if</span> !<span class="hljs-keyword">self</span>.data.has_task() &#123; <span class="hljs-comment">// ä¸€ä¸ªå°ä¼˜åŒ–ï¼Œæœ‰æœºä¼šé¿å…ä¸€æ¬¡cond_guardçš„åŠ é”</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> guard = <span class="hljs-keyword">self</span>.data.cond_guard.lock().expect(<span class="hljs-string">&quot;can&#x27;t lock cond guard&quot;</span>);<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">self</span>.data.has_task() &#123;<br>            guard = <span class="hljs-keyword">self</span>.data.cond.wait(guard).unwrap();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>ğŸ®ğŸºï¼Œæµ‹è¯•é€šè¿‡ï¼ğŸ‰ğŸ‰ğŸ‰ğŸ‰é˜¶æ®µæ€§æˆæœï¼æˆåŠŸå®Œæˆäº†æ­£å¸¸å·¥ä½œçš„<code>join</code></p>
<h2 id="åŠ¨æ€è®¾ç½®å·¥ä½œçº¿ç¨‹æ•°"><a href="#åŠ¨æ€è®¾ç½®å·¥ä½œçº¿ç¨‹æ•°" class="headerlink" title="åŠ¨æ€è®¾ç½®å·¥ä½œçº¿ç¨‹æ•°"></a>åŠ¨æ€è®¾ç½®å·¥ä½œçº¿ç¨‹æ•°</h2><p>çº¿ç¨‹æ± åˆ›å»ºä¹‹åï¼Œå¦‚æœæƒ³è¦åŠ¨æ€å¢åŠ æˆ–è€…å‡å°‘çº¿ç¨‹æ•°é‡å¯å’‹æï¼Ÿåˆ†ä¸¤ç§æƒ…å†µæ¥è€ƒè™‘ã€‚</p>
<ol>
<li>å·¥ä½œçº¿ç¨‹æ•°å¢åŠ ï¼Œå·®å¤šå°‘ä¸ªï¼Œå°±è°ƒç”¨å¤šå°‘æ¬¡<code>spawn_in_pool</code>ï¼Œè¡¥é½å·®è·ã€‚</li>
<li>å·¥ä½œçº¿ç¨‹å‡å°‘ï¼Œé‚£å°±è¦è®©ä¸€äº›å·¥ä½œçº¿ç¨‹è‡ªåŠ¨åœ°breakï¼Œé€€å‡ºåè‡ªåŠ¨è¢«å›æ”¶ã€‚æ€ä¹ˆè®©è¿™äº›å¤šä½™çš„çº¿ç¨‹çŸ¥é“è‡ªå·±è¢«ä¸‹å²—äº†å‘¢ï¼Ÿç°åœ¨æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ä¸èƒ½åŠ¨ï¼Œé‚£äº›æ‰§è¡Œå®Œï¼Œå†æ¬¡å¾ªç¯å»å·¥ä½œé˜Ÿåˆ—é‡Œæ‹¿ä»»åŠ¡å‰ï¼Œå°±å¯ä»¥æ£€æŸ¥å¤šå°‘çº¿ç¨‹æ­£åœ¨å·¥ä½œ<code>active_cnt</code>ï¼Œå¦‚æœå¤§äºè®¾å®šçš„æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆè‡ªå·±å°±ä¸»åŠ¨é€€å‡ºã€‚</li>
</ol>
<p>æ‰€ä»¥æ€è·¯å°±æ˜¯</p>
<ul>
<li>åœ¨<code>SharedData</code>é‡Œå¢åŠ ä¸€ä¸ª<code>max_threads_cnt</code>å­—æ®µï¼›</li>
<li>ç»™<code>ThreadPool</code>å®ç°<code>set_threads_num</code>æ–¹æ³•ï¼Œå¦‚æœæ˜¯å¢åŠ ï¼Œå°±è°ƒç”¨<code>spawn_in_pool</code>è¡¥é½ï¼›</li>
<li>å·¥ä½œçº¿ç¨‹çš„æ¯æ¬¡å–ä»»åŠ¡å‰éƒ½æ£€æŸ¥ä¸€ä¸‹<code>active_cnt</code>æ˜¯å¦å¤§äº<code>max_threads_cnt</code>ï¼Œæ˜¯å°±breakï¼›</li>
</ul>
<p>åä¸¤ç‚¹å˜åŠ¨çš„ä»£ç æ˜¯</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> ThreadPool &#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">set_threads_num</span></span>(&amp;<span class="hljs-keyword">self</span>, size: <span class="hljs-built_in">usize</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> prev_cnt = size;<br>        &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> p_thread_cnt = <span class="hljs-keyword">self</span><br>                .data<br>                .max_threads_cnt<br>                .lock()<br>                .expect(<span class="hljs-string">&quot;can&#x27;t lock max_threads_cnt&quot;</span>);<br>            prev_cnt = *p_thread_cnt;<br>            *p_thread_cnt = size;<br>        &#125;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Some</span>(n) = size.checked_sub(prev_cnt) &#123;<br>            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..n &#123;<br>                <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">self</span>.data.clone();<br>                spawn_in_pool(data);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">spawn_in_pool</span></span>(data: Arc&lt;SharedData&gt;) &#123;<br>    &#123;<br>        <span class="hljs-keyword">if</span> *data.active_cnt.lock().unwrap() &gt;= *data.max_threads_cnt.lock().unwrap() &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>	&#125;<br>    <span class="hljs-comment">// ...å–å‡ºä»»åŠ¡</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<h2 id="å·¥ä½œçº¿ç¨‹panicæ€ä¹ˆåŠ"><a href="#å·¥ä½œçº¿ç¨‹panicæ€ä¹ˆåŠ" class="headerlink" title="å·¥ä½œçº¿ç¨‹panicæ€ä¹ˆåŠ"></a>å·¥ä½œçº¿ç¨‹panicæ€ä¹ˆåŠ</h2><p>å¦‚æœä»»åŠ¡é—­åŒ…<code>job_fn</code>æ‰§è¡Œäº§ç”Ÿäº†panicï¼Œé‚£ä¹ˆä¼šäº§ç”Ÿä»€ä¹ˆå½±å“ï¼Ÿé¦–å…ˆæ˜¯çº¿ç¨‹é€€å‡º</p>
<ul>
<li>çº¿ç¨‹é€€å‡ºï¼Œå·¥ä½œçº¿ç¨‹ä¸ç­‰äºå½“åˆè®¾å®šçš„çº¿ç¨‹æ•°</li>
<li><code>job_fn</code>åé¢çš„ä»£ç æ²¡æœ‰æ‰§è¡Œï¼š<code>active_cnt</code>æ²¡æœ‰å‡ä¸€ã€æ²¡æœ‰é€šçŸ¥<code>join</code></li>
</ul>
<p>æ‰€ä»¥å› panicé€€å‡ºæ—¶ï¼Œå¾—æ‰§è¡Œè¢«è·³è¿‡çš„é€»è¾‘ï¼Œå¹¶ä¸”é‡å¯çº¿ç¨‹ã€‚</p>
<p>panicé€€å‡ºæ—¶è¿˜è¦æ‰§è¡Œä»£ç ï¼Ÿè¿™å’‹åŠå‘¢ï¼Œåªèƒ½æ˜¯æŸä¸ªç»“æ„å®ç°<code>Drop</code>traitï¼Œåœ¨<code>drop</code>æ–¹æ³•ä¸­æ‰§è¡Œæ²¡æœ‰æ‰§è¡Œå®Œçš„é€»è¾‘ã€‚ä¸‹é¢æ˜¯æºç ä¸­<code>Sentinel</code>å“¨å…µçš„å®ç°ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt; Sentinel&lt;<span class="hljs-symbol">&#x27;a</span>&gt; &#123;<br>    <span class="hljs-comment">// åœ¨å·¥ä½œçº¿ç¨‹è¿›å…¥loopå‰ï¼Œnewä¸€ä¸ªæ–°é²œçš„sentinel</span><br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">new</span></span>(shared_data: &amp;<span class="hljs-symbol">&#x27;a</span> Arc&lt;ThreadPoolSharedData&gt;) -&gt; Sentinel&lt;<span class="hljs-symbol">&#x27;a</span>&gt; &#123;<br>        Sentinel &#123;<br>            shared_data: shared_data,<br>            active: <span class="hljs-literal">true</span>,<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/// loopæ­£å¸¸breakå‡ºæ¥ï¼Œæ‰§è¡Œcancel.</span><br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">cancel</span></span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">self</span>.active = <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt; <span class="hljs-built_in">Drop</span> <span class="hljs-keyword">for</span> Sentinel&lt;<span class="hljs-symbol">&#x27;a</span>&gt; &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">drop</span></span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.active &#123; <span class="hljs-comment">// è¯´æ˜ä¸æ˜¯breakæ­£å¸¸é€€å‡º</span><br>            <span class="hljs-keyword">self</span>.shared_data.active_count.fetch_sub(<span class="hljs-number">1</span>, Ordering::SeqCst);<br>            <span class="hljs-keyword">if</span> thread::panicking() &#123; <br>                <span class="hljs-keyword">self</span>.shared_data.panic_count.fetch_add(<span class="hljs-number">1</span>, Ordering::SeqCst);<br>            &#125;<br>            <span class="hljs-keyword">self</span>.shared_data.no_work_notify_all();<br>            spawn_in_pool(<span class="hljs-keyword">self</span>.shared_data.clone())<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>ç„¶åæˆ‘çš„ç–‘é—®æ˜¯ï¼šä¸ºä»€ä¹ˆä¼šæœ‰å“¨å…µçš„<code>active</code>å­—æ®µå’Œ<code>thread::panicking()</code>çš„åŒé‡æ£€æŸ¥ï¼Ÿéæ­£å¸¸é€€å‡ºé™¤äº†panicè¿˜æœ‰å…¶ä»–çš„æƒ…å†µï¼Ÿå¦‚æœæ˜¯å…¶ä»–æƒ…å†µï¼Œä¸ºä»€ä¹ˆè¿›å…¥activeåˆ†æ”¯åç›´æ¥å¯¹<code>active_cnt</code>è¿›è¡Œå‡1æ“ä½œï¼Œè¿™ä¸ªæ“ä½œçš„æ½œåœ¨å‡è®¾æ˜¯é€»è¾‘æµä¸€å®šä¸­æ­¢äºé—­åŒ…è°ƒç”¨å‘€ï¼Œé‚£ä¹ˆé™¤äº†<code>job_fn</code>æœ¬èº«panicï¼Œè¿˜èƒ½æœ‰ä»€ä¹ˆå¯èƒ½æ»¡è¶³è¿™ä¸ªå‡è®¾å‘¢ï¼Ÿæˆ‘è¿˜è¯•è¿‡äº†ï¼Œæºä»£ç å®ç°ä¸­ï¼Œå¦‚æœè·å–è·å–å·¥ä½œé˜Ÿåˆ—é”å¤±è´¥ï¼Œ<code>expect</code>äº§ç”Ÿçš„panicä¹Ÿä¼šè¿›å…¥<code>drop</code>æ–¹æ³•ï¼Œé€ æˆ<code>active_count</code>å‡1åæº¢å‡ºï¼Œè¡Œä¸ºå®Œå…¨å¤±æ§ã€‚</p>
<p>æˆ‘ä¸ªäººçœ‹æ³•ï¼Œæ­£ç¡®çš„è§£å†³åŠæ³•ï¼Œåº”è¯¥æ˜¯<code>drop</code>åªåº”å¯¹ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯ä»»åŠ¡é—­åŒ…panicï¼Œè¿™æ˜¯å”¯ä¸€ä¸å¯æ§çš„ä»£ç ï¼Œå…¶ä»–æƒ…å†µå¦‚æœå‡ºç°errorï¼Œå°±åœ°å¤„ç†ï¼Œæ¯”å¦‚å·¥ä½œé˜Ÿåˆ—è·å–é”ï¼Œå¦‚æœå¤±è´¥ï¼Œæ ‡è®°sentinelçš„<code>drop</code>ä¸è¦å¤„ç†ï¼Œä¸»åŠ¨<code>spand_in_pool</code>æŒ½æ•‘ã€‚åƒæˆ‘è¿™é‡Œæ²¡æœ‰ä½¿ç”¨<code>AtomicXxx</code>ï¼Œè·å–çŠ¶æ€å­—æ®µæ—¶å‡ºé”™ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸¥é‡çš„è¿è¡Œæ—¶é—®é¢˜ï¼Œå·²ç»æ— æ³•ç»´æŒçº¿ç¨‹æ± çš„æ­£ç¡®çŠ¶æ€ï¼Œä¹Ÿæ˜¯æ ‡è®°<code>drop</code>ä¸è¦å¤„ç†ï¼ŒåŒæ—¶æ ‡è®°çº¿ç¨‹æ± åœæ­¢å·¥ä½œï¼ŒæŠ›å‡ºpanicã€‚</p>
<h2 id="è¿˜æœ‰ä»€ä¹ˆå¯ä»¥åšçš„å—ï¼Ÿ"><a href="#è¿˜æœ‰ä»€ä¹ˆå¯ä»¥åšçš„å—ï¼Ÿ" class="headerlink" title="è¿˜æœ‰ä»€ä¹ˆå¯ä»¥åšçš„å—ï¼Ÿ"></a>è¿˜æœ‰ä»€ä¹ˆå¯ä»¥åšçš„å—ï¼Ÿ</h2><ul>
<li>ç°åœ¨å¼‚å¸¸åªä¼šè®¡æ•°ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç»™æ¯ä¸ªä»»åŠ¡å¢åŠ åå­—ï¼Œjoinä¹‹åå¯ä»¥é‡æ–°æ‰§è¡Œå¤±è´¥çš„ä»»åŠ¡ï¼Ÿ</li>
<li>ä»»åŠ¡è¶…æ—¶æ€ä¹ˆåŠï¼Ÿ<code>ThreadPool</code>ç»“æ„å°±å¾—ä¸»åŠ¨æ€æ­»çº¿ç¨‹ï¼Œæ‰€ä»¥è¿˜å¾—å…±äº«ä¸€ä¸ª&lt;çº¿ç¨‹id-çŠ¶æ€&gt;çš„æ˜ å°„ï¼Ÿ</li>
<li>æŠŠå·¥ä½œé˜Ÿåˆ—çš„æ€§è´¨ä¹Ÿåšæˆåˆå§‹åŒ–å‚æ•°ï¼Ÿç”¨æˆ·å¯ä»¥é€‰æ‹©ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—å’Œæ— ç•Œé˜Ÿåˆ—ï¼Ÿ</li>
<li>å·¥ä½œçº¿ç¨‹panicçš„é—®é¢˜ï¼Œè¿˜å¾…ç¡®è®¤è§£å†³æ–¹æ¡ˆã€‚</li>
<li>æºä»£ç ä¸­çš„<code>test_threads_num_decreasing</code>æµ‹è¯•ç”¨ä¾‹æœ‰è¯¯ï¼Œç¬¬äºŒæ¬¡<code>execute</code>çš„æ•°é‡åº”è¯¥å¤šäº<code>new_threads_num</code></li>
</ul>
<p>OKï¼Œçº¿ç¨‹æ± çš„æºç è§£æå°±åˆ°è¿™é‡Œå§ï¼ŒæŒºæœ‰æ”¶è·çš„</p>
<ol>
<li>ç»ˆäºæ˜ç™½äº†çº¿ç¨‹æ± çš„æ¨¡å‹ï¼ŒåŸæ¥æ˜¯é˜Ÿåˆ—+å¤šä¸ªloopçº¿ç¨‹ğŸ‘</li>
<li>ç†Ÿæ‚‰äº†rustä¸­çš„çº¿ç¨‹åŒæ­¥å·¥å…·ã€‚ç®—æ˜¯å¯¹<a target="_blank" rel="noopener" href="https://limpet.net/mbrubeck/2019/02/07/rust-a-unique-perspective.html"><code>Unique+Share</code></a>è§’åº¦çš„å¤ä¹ ï¼Œè¿™ä¸ªè§’åº¦æ€è€ƒçœŸçš„éå¸¸æœ‰ç”¨ï¼<code>Arc</code>ã€<code>Mutex</code>å•¥çš„çœ‹å¾—æ›´æ¸…æ¥šäº†ã€‚</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Rust/">Rust</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/02/05/pygc/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Pythonçš„åƒåœ¾å›æ”¶æ¢—æ¦‚</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/01/12/serde-what-are-you-doing-practice-resp-ser/">
                        <span class="hidden-mobile">serdeä½ åœ¨å¹²ä»€ä¹ˆ - å®è·µç¯‡ - serialize</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-svg.js" ></script>

  








  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?69fdc2c3cb74b3ea985d8b632943139a";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->



</body>
</html>
